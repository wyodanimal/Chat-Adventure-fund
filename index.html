<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure Fund</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --panel:#101823;
      --panel2:#0f1620;
      --card:#121c2a;
      --line:rgba(255,255,255,.08);
      --text:#e8eef7;
      --muted:#9fb0c9;
      --muted2:#7f8aa3;

      --good:#3fd28c;
      --bad:#ff5d5d;
      --warn:#ffcc66;
      --accent:#7dd3fc;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(125,211,252,.05), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:26px 22px 42px;}
    .top{display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:14px;}
    .title{display:flex;flex-direction:column;gap:6px;}
    .title h1{margin:0;font-weight:800;letter-spacing:-.02em;font-size:28px}
    .subtitle{color:var(--muted);font-size:13px;max-width:780px;line-height:1.35}

    .yearRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pillRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
    .pill.active{
      background:linear-gradient(180deg, rgba(125,211,252,.18), rgba(125,211,252,.10));
      border-color:rgba(125,211,252,.35);
    }

    .layout{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:14px;
      margin-top:14px;
    }
    .nav{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      height: fit-content;
    }
    .navBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
      margin-bottom:8px;
    }
    .navBtn:hover{background:rgba(255,255,255,.04)}
    .navBtn.active{
      background:rgba(125,211,252,.10);
      border-color:rgba(125,211,252,.25);
    }
    .navLeft{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.18);box-shadow:0 0 0 3px rgba(255,255,255,.04);}
    .navBtn.active .dot{background:rgba(125,211,252,.8); box-shadow:0 0 0 3px rgba(125,211,252,.15)}
    .navLabel{font-weight:800;font-size:13px}
    .navHint{color:var(--muted2);font-size:12px}

    .main{min-width:0;}
    .panel{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .grid4{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .nav{position:relative;top:auto}
      .grid4{grid-template-columns: 1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:14px;
      min-height:108px;
      overflow:hidden; /* fixes bleed */
    }
    .kLabel{color:var(--muted);font-size:12px;letter-spacing:.02em;text-transform:uppercase}
    .kVal{font-size:30px;font-weight:900;margin-top:6px;letter-spacing:-.02em}
    .kSub{margin-top:6px;color:var(--muted2);font-size:12px;line-height:1.35}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    .barWrap{margin-top:10px;height:12px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid rgba(255,255,255,.08);}
    .bar{height:100%;width:0%;background:var(--good);transition:width .25s ease;}

    .row{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row:last-child{border-bottom:none}
    .rowTitle{font-weight:800;font-size:14px}
    .rowMeta{color:var(--muted2);font-size:12px;margin-top:2px;line-height:1.35}
    .rowRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.12);}
    .btn.good{border-color:rgba(63,210,140,.35);background:rgba(63,210,140,.10);}
    .btn.bad{border-color:rgba(255,93,93,.35);background:rgba(255,93,93,.10);}

    .tag{
      font-family:var(--mono);
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.02);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .twoCol{display:grid;grid-template-columns: 1.2fr .8fr;gap:12px;margin-top:12px;}
    @media (max-width:980px){.twoCol{grid-template-columns:1fr}}

    .fieldRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input, select{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-size:13px;
      outline:none;
      min-width: 140px;
    }
    input:focus, select:focus{border-color:rgba(125,211,252,.35)}
    .miniHelp{color:var(--muted2);font-size:12px;margin-top:8px;line-height:1.45}

    .monoBox{
      font-family:var(--mono);
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.30);
      white-space:pre;
      overflow:auto;
      max-height:260px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Adventure Fund</h1>
        <div class="subtitle">Deterministic fund allocation engine (sheet-backed). Accounts + Category budgets + Trips feed projections. No demos, no mock state.</div>
      </div>

      <div class="yearRow">
        <div class="pillRow" id="yearPills"></div>
        <div class="pillRow">
          <button class="btn primary" id="refreshBtn">Refresh Sheet</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="nav">
        <button class="navBtn active" data-view="dashboard">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Dashboard</div><div class="navHint">Fund • reserved • runway</div></div></div>
        </button>
        <button class="navBtn" data-view="accounts">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Accounts</div><div class="navHint">Balances + transfers</div></div></div>
        </button>
        <button class="navBtn" data-view="categories">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Categories</div><div class="navHint">Budget • spent • remaining</div></div></div>
        </button>
        <button class="navBtn" data-view="trips">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Trips</div><div class="navHint">Fuel + lodging totals</div></div></div>
        </button>
        <button class="navBtn" data-view="settings">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Settings</div><div class="navHint">Accurizer + staging</div></div></div>
        </button>

        <div style="height:10px"></div>
        <div class="miniHelp">
          <b>Accurizer</b> sets today’s real-world balances as truth and projections continue forward from that baseline.
        </div>
      </div>

      <div class="main">
        <!-- DASHBOARD -->
        <div class="panel" data-panel="dashboard">
          <div class="grid4">
            <div class="card">
              <div class="kLabel">Total Fund</div>
              <div class="kVal" id="k_totalFund">$0</div>
              <div class="kSub" id="k_totalFund_sub">Sum of included accounts (Actual_Balances)</div>
            </div>
            <div class="card">
              <div class="kLabel">Reserved</div>
              <div class="kVal" id="k_reserved">$0</div>
              <div class="kSub">Sum of category budgets (Category_Budgets)</div>
            </div>
            <div class="card">
              <div class="kLabel">Free Liquidity</div>
              <div class="kVal" id="k_free">$0</div>
              <div class="kSub">Total Fund − Reserved</div>
            </div>
            <div class="card">
              <div class="kLabel">Projected Year-End</div>
              <div class="kVal" id="k_yearEnd">$0</div>
              <div class="kSub" id="k_buffer">—</div>
              <div class="barWrap"><div class="bar" id="goalBar"></div></div>
            </div>
          </div>

          <div class="twoCol">
            <div class="card">
              <div class="kLabel">Income Projection (remaining)</div>
              <div class="miniHelp">Calculated from <b>Income</b> tab. Biweekly rows are expanded deterministically by date cadence.</div>
              <div id="incomeSummary"></div>
            </div>

            <div class="card">
              <div class="kLabel">Trips Rollup</div>
              <div class="miniHelp">Trips in <b>planned</b> status count toward projection. Completed trips stay visible but do not count.</div>
              <div class="row">
                <div>
                  <div class="rowTitle">Planned Trips Total</div>
                  <div class="rowMeta">Sum of Trip Total where Year matches and Status=planned</div>
                </div>
                <div class="rowRight"><span class="tag" id="tripPlannedTotal">$0</span></div>
              </div>
              <div class="row">
                <div>
                  <div class="rowTitle">Projected Fuel</div>
                  <div class="rowMeta">Sum of Final Fuel Cost where Year matches and Status=planned</div>
                </div>
                <div class="rowRight"><span class="tag" id="tripFuelTotal">$0</span></div>
              </div>
              <div class="row">
                <div>
                  <div class="rowTitle">Projected Lodging</div>
                  <div class="rowMeta">Sum of Lodging Cost where Year matches and Status=planned</div>
                </div>
                <div class="rowRight"><span class="tag" id="tripLodgingTotal">$0</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ACCOUNTS -->
        <div class="panel" data-panel="accounts" style="display:none">
          <div class="card">
            <div class="kLabel">Accounts</div>
            <div class="miniHelp">Balances are read from <b>Actual_Balances</b>. Transfers stage two transaction rows (out/in) for paste into Transactions (if you use one).</div>
            <div id="acct_list"></div>

            <div style="height:12px"></div>
            <div class="kLabel">Transfer</div>
            <div class="fieldRow">
              <select id="xfer_from"></select>
              <select id="xfer_to"></select>
              <input id="xfer_amt" type="number" step="0.01" placeholder="Amount" style="width:160px">
              <input id="xfer_date" type="date" style="width:170px">
              <button class="btn primary" id="xfer_stage">Stage Transfer</button>
            </div>
            <div class="miniHelp">Transfers do not change Total Fund. They move money between accounts.</div>
          </div>
        </div>

        <!-- CATEGORIES -->
        <div class="panel" data-panel="categories" style="display:none">
          <div class="card">
            <div class="kLabel">Category Budgets</div>
            <div class="miniHelp">
              Budgets come from <b>Category_Budgets</b>. Entire budget is reserved against projection. Item-level is for planning only.
            </div>
            <div id="cat_list"></div>
          </div>
        </div>

        <!-- TRIPS -->
        <div class="panel" data-panel="trips" style="display:none">
          <div class="card">
            <div class="kLabel">Trips</div>
            <div class="miniHelp">Pulled from <b>Trips</b>. Only <b>planned</b> counts toward projections; completed stays visible.</div>
            <div id="trip_list"></div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="panel" data-panel="settings" style="display:none">
          <div class="card">
            <div class="kLabel">Accurizer (Set today’s real balances)</div>
            <div class="miniHelp">
              Enter your real-world balances. This stages adjustment transactions (one per account) so the sheet can be updated deterministically.
              If your sheet already uses Actual_Balances as truth, you can still use this to generate your paste rows and then update the sheet.
            </div>
            <div id="accurizer"></div>
            <div class="fieldRow">
              <input id="acc_date" type="date" style="width:170px">
              <button class="btn primary" id="acc_stage">Stage Balance Adjustments</button>
              <button class="btn bad" id="staged_clear">Clear Staged Rows</button>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div class="kLabel">Staged Rows (copy/paste)</div>
            <div class="miniHelp">Paste these into your Transactions tab (schema: <b>txn_id,date,account_id,amount,type,projected,category</b>).</div>
            <div class="fieldRow">
              <button class="btn" id="copyStaged">Copy</button>
            </div>
            <div class="monoBox" id="stagedBox">(none)</div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div class="kLabel">Data Health</div>
            <div class="miniHelp" id="healthBox">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG — YOUR CSV ENDPOINTS
   ========================= */
const BASE = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=";

const ACTUAL_BALANCES_CSV   = BASE + "0&single=true&output=csv";
const INCOME_CSV            = BASE + "1567617658&single=true&output=csv";
const CATEGORY_BUDGETS_CSV  = BASE + "1140620863&single=true&output=csv";
const PLANNED_ITEMS_CSV     = BASE + "832851607&single=true&output=csv";
const TRIPS_CSV             = BASE + "2037449837&single=true&output=csv";
const VEHICLE_LOOKUP_CSV    = BASE + "1613648940&single=true&output=csv";
const YEAR_SETTINGS_CSV     = BASE + "1350021405&single=true&output=csv";

// Optional: add Transactions CSV once you provide its gid.
// const TRANSACTIONS_CSV      = BASE + "PASTE_GID_HERE&single=true&output=csv";

/* =========================
   STATE
   ========================= */
const now = new Date();
const BASE_YEAR = now.getFullYear();
const LS_KEY = "af_live_v2";
const state = loadState() || {
  year: 2026,
  staged: [], // staged transaction rows (strings)
  // sheet data
  accounts: [],
  income: [],
  cats: [],
  items: [],
  trips: [],
  yearSettings: [],
  vehicle: [],
  // health
  health: { loadedAt: null, errors: [] }
};

function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

function isoDate(d){
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function money(n){
  const v = Number(n||0);
  const sign = v < 0 ? "-" : "";
  return sign + "$" + Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function uid(){ return "txn_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
function safeNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

/* =========================
   CSV parsing (robust)
   ========================= */
function parseCSV(text){
  // Handles quoted fields + commas inside quotes.
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];
    if(inQ){
      if(ch === '"' && next === '"'){ cur += '"'; i++; }
      else if(ch === '"'){ inQ = false; }
      else { cur += ch; }
    } else {
      if(ch === '"'){ inQ = true; }
      else if(ch === ','){ row.push(cur); cur=""; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; }
      else if(ch === '\r'){ /* ignore */ }
      else { cur += ch; }
    }
  }
  row.push(cur);
  rows.push(row);
  // trim empty trailing rows
  while(rows.length && rows[rows.length-1].every(c => String(c||"").trim()==="")) rows.pop();
  return rows;
}
async function fetchCSV(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("Fetch failed: " + res.status);
  return res.text();
}
function headMap(head){
  const m = {};
  head.forEach((h,i)=> m[String(h||"").trim()] = i);
  return m;
}

/* =========================
   Load Sheet Data
   ========================= */
async function loadSheetData(){
  state.health = { loadedAt: isoDate(new Date()), errors: [] };

  const pulls = await Promise.allSettled([
    fetchCSV(ACTUAL_BALANCES_CSV),
    fetchCSV(INCOME_CSV),
    fetchCSV(CATEGORY_BUDGETS_CSV),
    fetchCSV(PLANNED_ITEMS_CSV),
    fetchCSV(TRIPS_CSV),
    fetchCSV(VEHICLE_LOOKUP_CSV),
    fetchCSV(YEAR_SETTINGS_CSV)
  ]);

  const get = (idx, label) => {
    const p = pulls[idx];
    if(p.status !== "fulfilled"){
      state.health.errors.push(label + ": " + (p.reason?.message || "failed"));
      return "";
    }
    return p.value;
  };

  // Actual_Balances
  {
    const rows = parseCSV(get(0,"Actual_Balances"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.accounts = rows
      .filter(r => String(r[hm.account_id]||"").trim())
      .map(r => ({
        account_id: String(r[hm.account_id]||"").trim(),
        account_name: String(r[hm.account_name]||"").trim(),
        current_balance: safeNum(r[hm.current_balance]),
        include_in_projection: String(r[hm.include_in_projection]||"TRUE").trim().toUpperCase() !== "FALSE"
      }));
  }

  // Income
  {
    const rows = parseCSV(get(1,"Income"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.income = rows
      .filter(r => String(r[hm.income_id]||"").trim())
      .map(r => ({
        income_id: String(r[hm.income_id]||"").trim(),
        income_type: String(r[hm.income_type]||"").trim(),
        description: String(r[hm.description]||"").trim(),
        amount: safeNum(r[hm.amount]),
        recurrence: String(r[hm.recurrence]||"").trim(),
        start_date: String(r[hm.start_date]||"").trim(),
        year: safeNum(r[hm.year]),
        received: String(r[hm.received]||"FALSE").trim().toUpperCase() === "TRUE",
        effective_until_year: hm.effective_until_year !== undefined ? safeNum(r[hm.effective_until_year]) : null
      }));
  }

  // Category_Budgets
  {
    const rows = parseCSV(get(2,"Category_Budgets"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.cats = rows
      .filter(r => String(r[hm.category_id]||"").trim())
      .map(r => ({
        category_id: String(r[hm.category_id]||"").trim(),
        category_name: String(r[hm.category_name]||"").trim(),
        annual_budget: safeNum(r[hm.annual_budget]),
        year: safeNum(r[hm.year])
      }));
  }

  // Planned_Items
  {
    const rows = parseCSV(get(3,"Planned_Items"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.items = rows
      .filter(r => String(r[hm.item_id]||"").trim())
      .map(r => ({
        item_id: String(r[hm.item_id]||"").trim(),
        category_id: String(r[hm.category_id]||"").trim(),
        item_name: String(r[hm.item_name]||"").trim(),
        projected_cost: safeNum(r[hm.projected_cost]),
        yearRaw: String(r[hm.year]||"").trim()
      }));
  }

  // Trips
  {
    const rows = parseCSV(get(4,"Trips"));
    const head = rows.shift() || [];
    // support both old and your current headers
    const hm = headMap(head.map(x=>String(x||"").trim()));
    const col = (name, fallbackIdx) => (hm[name] !== undefined ? hm[name] : fallbackIdx);

    state.trips = rows
      .filter(r => String(r[col("Trip Name",0)]||"").trim())
      .map(r => ({
        name: String(r[col("Trip Name",0)]||"").trim(),
        plannedMiles: safeNum(r[col("Planned Miles",1)]),
        vehicle: String(r[col("Vehicle",2)]||"").trim(),
        mpg: safeNum(r[col("MPG",3)]),
        fuelPrice: safeNum(r[col("Fuel Price",4)]),
        finalFuel: safeNum(r[col("Final Fuel Cost",8)]), // matches your sheet after removing blank col
        lodging: safeNum(r[col("Lodging Cost",9)]),
        total: safeNum(r[col("Trip Total",10)]),
        year: safeNum(r[col("Year",11)]),
        status: String(r[col("Status",12)]||"planned").trim().toLowerCase()
      }));
  }

  // Vehicle_Lookup
  {
    const rows = parseCSV(get(5,"Vehicle_Lookup"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.vehicle = rows
      .filter(r => String(r[hm.Vehicle]||r[hm.vehicle]||"").trim())
      .map(r => {
        const v = String(r[hm.Vehicle] ?? r[hm.vehicle] ?? "").trim();
        const mpg = safeNum(r[hm.MPG] ?? r[hm.mpg]);
        return { vehicle: v, mpg };
      });
  }

  // Year_Settings
  {
    const rows = parseCSV(get(6,"Year_Settings"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.yearSettings = rows
      .filter(r => safeNum(r[hm.year]) )
      .map(r => ({
        year: safeNum(r[hm.year]),
        minimum_balance: safeNum(r[hm.minimum_balance]),
        auto_increment: safeNum(r[hm.auto_increment])
      }));
  }

  saveState();
}

/* =========================
   Deterministic Projection Engine
   ========================= */
function sumIncludedAccounts(){
  return state.accounts.filter(a=>a.include_in_projection).reduce((s,a)=>s + safeNum(a.current_balance), 0);
}
function yearMinBalance(year){
  const y = state.yearSettings.find(x=>x.year===year);
  return y ? safeNum(y.minimum_balance) : 0;
}
function yearAutoInc(year){
  const y = state.yearSettings.find(x=>x.year===year);
  return y ? safeNum(y.auto_increment) : 0;
}
function reservedBudgets(year){
  return state.cats.filter(c=>c.year===year).reduce((s,c)=>s + safeNum(c.annual_budget), 0);
}
function parseYearFromLoose(val){
  // supports "2026" or "6/2026"
  const s = String(val||"").trim();
  const m = s.match(/(\d{4})/);
  return m ? Number(m[1]) : 0;
}

function incomeRemaining(year){
  // One-time items: count if (year matches) and NOT received.
  // Biweekly: deterministic schedule from start_date, every 14 days, include only occurrences within the year that are after "today".
  const todayISO = isoDate(new Date());
  const today = new Date(todayISO + "T00:00:00");

  let total = 0;
  const details = [];

  for(const inc of state.income){
    if(inc.year !== year) continue;

    const rec = String(inc.recurrence||"").toLowerCase();

    if(rec === "biweekly"){
      const start = new Date(String(inc.start_date||"") + "T00:00:00");
      if(isNaN(start)) continue;

      // find first occurrence >= Jan 1 of year aligned to 14-day cadence
      const jan1 = new Date(year + "-01-01T00:00:00");
      const dec31 = new Date(year + "-12-31T00:00:00");

      // move forward/backwards in 14-day steps to get into year
      let d = new Date(start);
      while(d < jan1) d.setDate(d.getDate()+14);
      while(d > dec31) d.setDate(d.getDate()-14);

      // now walk forward within year
      let cntFuture = 0;
      let cntPast = 0;
      while(d.getFullYear() === year){
        if(d < today) cntPast++;
        else cntFuture++;
        d.setDate(d.getDate()+14);
      }

      const amt = safeNum(inc.amount);
      const add = cntFuture * amt;
      total += add;
      details.push({ label: inc.description || "Biweekly", amount: add, note: `${cntFuture} remaining (auto)` });

    } else {
      if(inc.received) continue;
      const add = safeNum(inc.amount);
      total += add;
      details.push({ label: inc.description || inc.income_type, amount: add, note: "pending" });
    }
  }

  return { total, details };
}

function plannedTripsRollup(year){
  const planned = state.trips.filter(t => t.year===year && (t.status||"planned")==="planned");
  return {
    total: planned.reduce((s,t)=>s+safeNum(t.total),0),
    fuel: planned.reduce((s,t)=>s+safeNum(t.finalFuel),0),
    lodging: planned.reduce((s,t)=>s+safeNum(t.lodging),0),
    count: planned.length
  };
}

function projectedYearEnd(year){
  const fund = sumIncludedAccounts();
  const reserved = reservedBudgets(year);
  const income = incomeRemaining(year).total;
  const yearEnd = fund + income - reserved;
  const floor = yearMinBalance(year);
  const buffer = yearEnd - floor;
  return { fund, reserved, free: fund - reserved, income, yearEnd, floor, buffer };
}

/* =========================
   UI
   ========================= */
function setView(view){
  $$(".navBtn").forEach(b=> b.classList.toggle("active", b.dataset.view===view));
  $$("[data-panel]").forEach(p=> p.style.display = (p.dataset.panel===view) ? "block" : "none");
}

function renderYears(){
  const ys = state.yearSettings.map(x=>x.year).filter(Boolean).sort((a,b)=>a-b);
  const years = ys.length ? ys.slice(0,5) : [BASE_YEAR, BASE_YEAR+1, BASE_YEAR+2];
  const host = $("#yearPills");
  host.innerHTML = "";
  for(const y of years){
    const b = document.createElement("button");
    b.className = "pill" + (state.year===y ? " active" : "");
    b.textContent = y;
    b.onclick = ()=>{ state.year=y; saveState(); renderAll(); };
    host.appendChild(b);
  }
}

function renderDashboard(){
  const y = state.year;
  const p = projectedYearEnd(y);

  $("#k_totalFund").textContent = money(p.fund);
  $("#k_reserved").textContent = money(p.reserved);
  $("#k_free").textContent = money(p.free);
  $("#k_yearEnd").textContent = money(p.yearEnd);

  const buf = $("#k_buffer");
  if(p.floor<=0){
    buf.innerHTML = `<span class="warn">Set Year_Settings minimum_balance for ${y}</span>`;
  } else if(p.buffer>=0){
    buf.innerHTML = `<span class="good">Buffer above floor: ${money(p.buffer)}</span>`;
  } else {
    buf.innerHTML = `<span class="bad">Below floor by: ${money(Math.abs(p.buffer))}</span>`;
  }

  const pct = p.floor>0 ? Math.max(0, Math.min(100, (p.yearEnd/p.floor)*100)) : 0;
  const bar = $("#goalBar");
  bar.style.width = pct + "%";
  bar.style.background = (p.floor>0 && p.buffer<0) ? "var(--bad)" : "var(--good)";

  // income summary
  const inc = incomeRemaining(y);
  const host = $("#incomeSummary");
  host.innerHTML = "";
  if(!inc.details.length){
    host.innerHTML = `<div class="miniHelp">No remaining income entries found for ${y}.</div>`;
  } else {
    host.appendChild(rowKV("Remaining Income Total", money(inc.total), `From Income tab (auto biweekly + pending one-time)`));
    for(const d of inc.details.slice(0,8)){
      host.appendChild(rowKV(d.label, money(d.amount), d.note));
    }
    if(inc.details.length>8){
      host.innerHTML += `<div class="miniHelp">+ ${inc.details.length-8} more…</div>`;
    }
  }

  // trips rollup
  const tr = plannedTripsRollup(y);
  $("#tripPlannedTotal").textContent = money(tr.total);
  $("#tripFuelTotal").textContent = money(tr.fuel);
  $("#tripLodgingTotal").textContent = money(tr.lodging);

  renderHealth();
}

function rowKV(title, val, meta){
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <div>
      <div class="rowTitle">${escapeHtml(title)}</div>
      <div class="rowMeta">${escapeHtml(meta||"")}</div>
    </div>
    <div class="rowRight"><span class="tag">${escapeHtml(val)}</span></div>
  `;
  return row;
}

function renderAccounts(){
  const host = $("#acct_list");
  host.innerHTML = "";

  // select options
  const from = $("#xfer_from");
  const to = $("#xfer_to");
  from.innerHTML = ""; to.innerHTML = "";
  for(const a of state.accounts){
    const o1 = document.createElement("option");
    o1.value = a.account_id;
    o1.textContent = `${a.account_name} (${a.account_id})`;
    const o2 = o1.cloneNode(true);
    from.appendChild(o1); to.appendChild(o2);
  }
  if(state.accounts.length>=2) to.selectedIndex = 1;

  for(const a of state.accounts){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(a.account_name)} <span class="tag" style="margin-left:6px">${escapeHtml(a.account_id)}</span></div>
        <div class="rowMeta">Included in projection: <b>${a.include_in_projection ? "TRUE" : "FALSE"}</b></div>
      </div>
      <div class="rowRight">
        <span class="tag">${money(a.current_balance)}</span>
      </div>
    `;
    host.appendChild(row);
  }

  $("#xfer_date").value = isoDate(new Date());
}

function renderCategories(){
  const y = state.year;
  const host = $("#cat_list");
  host.innerHTML = "";

  const cats = state.cats.filter(c=>c.year===y);
  if(!cats.length){
    host.innerHTML = `<div class="miniHelp">No Category_Budgets found for ${y}.</div>`;
    return;
  }

  // planned items rollup by category (planning-only)
  const items = state.items
    .map(it => ({...it, year: parseYearFromLoose(it.yearRaw)}))
    .filter(it => it.year===y);

  const byCat = new Map();
  for(const it of items){
    byCat.set(it.category_id, (byCat.get(it.category_id)||0) + safeNum(it.projected_cost));
  }

  for(const c of cats){
    const planned = byCat.get(c.category_id) || 0;
    const remainingPlan = safeNum(c.annual_budget) - planned;
    const pct = c.annual_budget>0 ? Math.max(0, Math.min(100, (planned/c.annual_budget)*100)) : 0;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div style="min-width:0;flex:1">
        <div class="rowTitle">${escapeHtml(c.category_name)} <span class="tag" style="margin-left:6px">${escapeHtml(c.category_id)}</span></div>
        <div class="rowMeta">
          Budget ${money(c.annual_budget)} • Planned items ${money(planned)} • Unplanned <span class="${remainingPlan>=0?'good':'bad'}">${money(remainingPlan)}</span>
        </div>
        <div class="barWrap" style="margin-top:8px">
          <div class="bar" style="width:${pct}%;background:${remainingPlan>=0?'var(--good)':'var(--bad)'}"></div>
        </div>
      </div>
      <div class="rowRight">
        <button class="btn" data-showitems="${escapeAttr(c.category_id)}">Show items</button>
      </div>
    `;
    host.appendChild(row);

    const details = document.createElement("div");
    details.style.display="none";
    details.style.padding="0 8px 10px 8px";
    details.innerHTML = buildItemsList(c.category_id, items);
    host.appendChild(details);

    row.querySelector(`button[data-showitems]`).onclick = ()=>{
      details.style.display = (details.style.display==="none") ? "block" : "none";
    };
  }
}

function buildItemsList(catId, items){
  const list = items.filter(i=>i.category_id===catId);
  if(!list.length) return `<div class="miniHelp">No planned items in this category for the selected year.</div>`;
  const lines = list
    .sort((a,b)=>safeNum(b.projected_cost)-safeNum(a.projected_cost))
    .slice(0,25)
    .map(i=>`• ${escapeHtml(i.item_name)} — ${money(i.projected_cost)}`)
    .join("<br>");
  return `<div class="miniHelp" style="margin-top:6px">${lines}</div>`;
}

function renderTrips(){
  const y = state.year;
  const host = $("#trip_list");
  host.innerHTML = "";

  const trips = state.trips.filter(t=>t.year===y);
  if(!trips.length){
    host.innerHTML = `<div class="miniHelp">No Trips found for ${y}.</div>`;
    return;
  }

  for(const t of trips){
    const isPlanned = (t.status||"planned")==="planned";
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(t.name)} <span class="tag" style="margin-left:6px">${escapeHtml(t.status||"planned")}</span></div>
        <div class="rowMeta">${escapeHtml(t.vehicle)} • ${t.plannedMiles} mi • ${money(t.finalFuel)} fuel • ${money(t.lodging)} lodging</div>
      </div>
      <div class="rowRight">
        <span class="tag">${money(t.total)}</span>
        <span class="tag" style="border-color:${isPlanned?'rgba(63,210,140,.35)':'rgba(255,93,93,.35)'};color:${isPlanned?'var(--good)':'var(--muted)'}">
          ${isPlanned ? "Counts in projection" : "Excluded (complete)"}
        </span>
      </div>
    `;
    host.appendChild(row);
  }
}

function renderAccurizer(){
  const host = $("#accurizer");
  host.innerHTML = "";
  for(const a of state.accounts){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(a.account_name)} <span class="tag" style="margin-left:6px">${escapeHtml(a.account_id)}</span></div>
        <div class="rowMeta">Current (sheet): ${money(a.current_balance)}</div>
      </div>
      <div class="rowRight">
        <input type="number" step="0.01" style="width:170px" data-acc="${escapeAttr(a.account_id)}" placeholder="Actual today">
      </div>
    `;
    host.appendChild(row);
  }
  $("#acc_date").value = isoDate(new Date());
}

function renderStaged(){
  const box = $("#stagedBox");
  box.textContent = state.staged.length ? state.staged.join("\n") : "(none)";
}

function renderHealth(){
  const h = state.health;
  const el = $("#healthBox");
  const errs = (h.errors||[]);
  if(!errs.length){
    el.innerHTML = `Loaded: <b>${escapeHtml(h.loadedAt||"—")}</b>. All required tabs fetched successfully.`;
  } else {
    el.innerHTML = `Loaded: <b>${escapeHtml(h.loadedAt||"—")}</b>. Issues:<br>` + errs.map(e=>`• ${escapeHtml(e)}`).join("<br>");
  }
}

/* =========================
   Actions: staging rows
   ========================= */
function stageTxn({date, account_id, amount, type, projected, category}){
  const line = [
    uid(),
    date,
    account_id,
    Number(amount).toFixed(2),
    type,
    projected ? "TRUE" : "FALSE",
    category || ""
  ].join(",");
  state.staged.push(line);
}

function wireUI(){
  // nav
  $$(".navBtn").forEach(b=> b.onclick = ()=> setView(b.dataset.view));

  $("#refreshBtn").onclick = async ()=>{
    $("#refreshBtn").textContent = "Refreshing…";
    try{
      await loadSheetData();
      renderAll();
    }catch(e){
      alert("Sheet refresh failed.\n\n" + e.message);
    } finally {
      $("#refreshBtn").textContent = "Refresh Sheet";
    }
  };

  // transfer staging
  $("#xfer_stage").onclick = ()=>{
    const from = $("#xfer_from").value;
    const to = $("#xfer_to").value;
    const amt = safeNum($("#xfer_amt").value);
    const date = $("#xfer_date").value || isoDate(new Date());
    if(!from || !to || from===to || !amt) return;

    stageTxn({ date, account_id: from, amount: -Math.abs(amt), type:"transfer_out", projected:false, category:"" });
    stageTxn({ date, account_id: to, amount: Math.abs(amt), type:"transfer_in", projected:false, category:"" });

    $("#xfer_amt").value = "";
    saveState();
    renderStaged();
    alert("Staged transfer rows (2). Go to Settings → Staged Rows to copy/paste.");
  };

  // accurizer staging
  $("#acc_stage").onclick = ()=>{
    const date = $("#acc_date").value || isoDate(new Date());
    const inputs = $$("#accurizer input[data-acc]");
    let staged = 0;

    for(const inp of inputs){
      const id = inp.getAttribute("data-acc");
      const val = inp.value;
      if(val === "") continue;
      const actual = safeNum(val);
      const acct = state.accounts.find(a=>a.account_id===id);
      if(!acct) continue;
      const delta = actual - safeNum(acct.current_balance);
      if(Math.abs(delta) < 0.005) continue;

      stageTxn({ date, account_id: id, amount: delta, type:"balance_adjust", projected:false, category:"" });
      staged++;
    }

    saveState();
    renderStaged();
    alert(staged ? `Staged ${staged} balance adjustment row(s).` : "No adjustments staged.");
  };

  $("#staged_clear").onclick = ()=>{
    state.staged = [];
    saveState();
    renderStaged();
  };

  $("#copyStaged").onclick = async ()=>{
    const txt = state.staged.join("\n");
    if(!txt) return;
    try{
      await navigator.clipboard.writeText(txt);
      alert("Copied staged rows to clipboard.");
    }catch{
      alert("Clipboard blocked. Copy manually from the box.");
    }
  };
}

function renderAll(){
  renderYears();
  renderDashboard();
  renderAccounts();
  renderCategories();
  renderTrips();
  renderAccurizer();
  renderStaged();
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function escapeAttr(s){ return String(s||"").replaceAll('"',"&quot;"); }

(async function init(){
  wireUI();
  setView("dashboard");
  try{ await loadSheetData(); } catch(e){ console.warn(e); }
  // default year: first Year_Settings year if present, else keep current
  if(state.yearSettings.length){
    state.year = state.yearSettings[0].year || state.year;
  }
  saveState();
  renderAll();
})();
</script>
</body>
</html>
