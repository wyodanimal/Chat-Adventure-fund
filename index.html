<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure Fund — Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --panel:#101823;
      --panel2:#0f1620;
      --card:#121c2a;
      --line:rgba(255,255,255,.08);
      --text:#e8eef7;
      --muted:#9fb0c9;
      --muted2:#7f8aa3;

      --good:#3fd28c;
      --bad:#ff5d5d;
      --warn:#ffcc66;
      --accent:#7dd3fc;
      --accent2:#9ae6b4;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(154,230,180,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:26px 22px 42px;}
    .top{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{display:flex;flex-direction:column;gap:6px;}
    .title h1{margin:0;font-weight:800;letter-spacing:-.02em;font-size:28px}
    .subtitle{color:var(--muted);font-size:13px}

    .yearRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pillRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
    .pill.active{
      background:linear-gradient(180deg, rgba(125,211,252,.18), rgba(154,230,180,.12));
      border-color:rgba(125,211,252,.35);
    }

    .layout{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:14px;
      margin-top:14px;
    }
    .nav{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      height: fit-content;
    }
    .navBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
      margin-bottom:8px;
    }
    .navBtn:hover{background:rgba(255,255,255,.04)}
    .navBtn.active{
      background:rgba(125,211,252,.10);
      border-color:rgba(125,211,252,.25);
    }
    .navLeft{display:flex;align-items:center;gap:10px}
    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .navBtn.active .dot{background:rgba(125,211,252,.7); box-shadow:0 0 0 3px rgba(125,211,252,.15)}
    .navLabel{font-weight:700;font-size:13px}
    .navHint{color:var(--muted2);font-size:12px}

    .main{min-width:0;}
    .panel{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .nav{position:relative;top:auto}
      .grid3{grid-template-columns: 1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:14px;
      min-height:104px;
    }
    .kLabel{color:var(--muted);font-size:12px;letter-spacing:.02em;text-transform:uppercase}
    .kVal{font-size:30px;font-weight:800;margin-top:6px;letter-spacing:-.02em}
    .kSub{margin-top:6px;color:var(--muted2);font-size:12px}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    .barWrap{
      margin-top:10px;
      height:12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar{
      height:100%;
      width:0%;
      background:var(--good);
      transition:width .25s ease;
    }

    .row{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row:last-child{border-bottom:none}
    .rowTitle{font-weight:700;font-size:14px}
    .rowMeta{color:var(--muted2);font-size:12px;margin-top:2px}
    .rowRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{
      border-color:rgba(125,211,252,.35);
      background:rgba(125,211,252,.12);
    }
    .btn.good{
      border-color:rgba(63,210,140,.35);
      background:rgba(63,210,140,.10);
    }
    .btn.bad{
      border-color:rgba(255,93,93,.35);
      background:rgba(255,93,93,.10);
    }
    .tag{
      font-family:var(--mono);
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.02);
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:980px){.twoCol{grid-template-columns:1fr}}

    .fieldRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input, select{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-size:13px;
      outline:none;
      min-width: 140px;
    }
    input:focus, select:focus{border-color:rgba(125,211,252,.35)}
    .miniHelp{color:var(--muted2);font-size:12px;margin-top:8px;line-height:1.45}

    .monoBox{
      font-family:var(--mono);
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.30);
      white-space:pre-wrap;
      word-break:break-word;
      max-height: 260px;
      overflow:auto;
    }
    .hintWarn{
      border:1px solid rgba(255,204,102,.25);
      background:rgba(255,204,102,.07);
      border-radius:12px;
      padding:10px 12px;
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Adventure Fund — Studio</h1>
        <div class="subtitle">Deterministic fund allocation + account ledger (sheet-backed). Commit Pack generates paste-ready rows.</div>
      </div>

      <div class="yearRow">
        <div class="pillRow" id="yearPills"></div>
        <div class="pillRow">
          <span class="tag">Goal Floor</span>
          <input id="goalInput" type="number" step="1" style="width:140px" />
          <button class="btn primary" id="refreshBtn">Refresh Sheet</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="nav">
        <button class="navBtn active" data-view="dashboard">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Dashboard</div><div class="navHint">Fund • reserved • buffer</div></div></div>
        </button>
        <button class="navBtn" data-view="accounts">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Accounts</div><div class="navHint">Balances + transfers</div></div></div>
        </button>
        <button class="navBtn" data-view="categories">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Categories</div><div class="navHint">Budget • spent • remaining</div></div></div>
        </button>
        <button class="navBtn" data-view="trips">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Trips</div><div class="navHint">Read sheet totals</div></div></div>
        </button>

        <div style="height:10px"></div>
        <div class="miniHelp">
          <b>Commit Pack</b> outputs paste-ready rows in your Transactions schema:
          <span class="tag">txn_id,date,account_id,amount,type,projected,category</span>
        </div>
      </div>

      <div class="main">
        <!-- DASHBOARD -->
        <div class="panel" data-panel="dashboard">
          <div class="grid3">
            <div class="card">
              <div class="kLabel">Total Fund</div>
              <div class="kVal" id="k_totalFund">$0</div>
              <div class="kSub" id="k_totalFund_sub">Sum of account balances (actual: projected=FALSE)</div>
            </div>
            <div class="card">
              <div class="kLabel">Reserved</div>
              <div class="kVal" id="k_reserved">$0</div>
              <div class="kSub">Sum of category budgets (Dashboard)</div>
            </div>
            <div class="card">
              <div class="kLabel">Free Liquidity</div>
              <div class="kVal" id="k_free">$0</div>
              <div class="kSub" id="k_projSub">Projected Year-End: —</div>
              <div class="barWrap"><div class="bar" id="goalBar"></div></div>
            </div>
          </div>

          <div class="twoCol">
            <div class="card">
              <div class="kLabel">Scenario Controls (optional)</div>
              <div class="fieldRow">
                <input id="sim_note" placeholder="Note (optional)" />
                <input id="sim_amount" type="number" step="1" placeholder="Amount (e.g., 650)" />
                <button class="btn bad" id="sim_add_cost">Add Cost</button>
                <button class="btn good" id="sim_add_income">Add Income</button>
                <button class="btn" id="sim_clear">Clear</button>
              </div>
              <div class="miniHelp">
                Scenario is a <b>UI-only delta</b> applied on top of projected year-end.
                It does not touch your sheet unless you stage commits separately.
              </div>
              <div class="row">
                <div>
                  <div class="rowTitle">Scenario Net</div>
                  <div class="rowMeta">income positive, costs negative</div>
                </div>
                <div class="rowRight">
                  <span class="tag" id="sim_net">$0</span>
                </div>
              </div>

              <div id="schemaWarn" class="hintWarn" style="display:none"></div>
            </div>

            <div class="card">
              <div class="kLabel">Commit Pack (copy/paste into Transactions)</div>
              <div class="miniHelp">
                Paste these rows under your Transactions header. You can clear this at any time.
              </div>
              <div class="fieldRow">
                <button class="btn" id="commit_copy">Copy</button>
                <button class="btn bad" id="commit_clear">Clear Commit Pack</button>
              </div>
              <div class="monoBox" id="commit_pack">(no staged commits yet)</div>
            </div>
          </div>
        </div>

        <!-- ACCOUNTS -->
        <div class="panel" data-panel="accounts" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <div class="kLabel">Transfer</div>
            <div class="fieldRow">
              <span class="tag">From</span>
              <select id="tr_from"></select>
              <span class="tag">To</span>
              <select id="tr_to"></select>
              <span class="tag">Amount</span>
              <input id="tr_amt" type="number" step="0.01" style="width:160px" />
              <span class="tag">Date</span>
              <input id="tr_date" type="date" style="width:170px" />
              <span class="tag">Projected?</span>
              <select id="tr_proj" style="min-width:120px">
                <option value="FALSE">FALSE</option>
                <option value="TRUE">TRUE</option>
              </select>
              <button class="btn primary" id="tr_stage">Stage Transfer (2 rows)</button>
            </div>
            <div class="miniHelp">
              Transfers create two transaction rows and do <b>not</b> change Total Fund.
              Category is set to <span class="tag">TRANSFER</span>.
            </div>
          </div>

          <div class="card">
            <div class="kLabel">Account Balances</div>
            <div id="acct_list"></div>
          </div>
        </div>

        <!-- CATEGORIES -->
        <div class="panel" data-panel="categories" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <div class="kLabel">Log Expense (staged)</div>
            <div class="fieldRow">
              <span class="tag">Account</span>
              <select id="ex_account"></select>
              <span class="tag">Category</span>
              <select id="ex_category" style="min-width:240px"></select>
              <span class="tag">Amount</span>
              <input id="ex_amt" type="number" step="0.01" style="width:160px" />
              <span class="tag">Date</span>
              <input id="ex_date" type="date" style="width:170px" />
              <span class="tag">Type</span>
              <select id="ex_type" style="min-width:140px">
                <option value="EXPENSE">EXPENSE</option>
                <option value="FUEL">FUEL</option>
                <option value="LODGING">LODGING</option>
                <option value="GEAR">GEAR</option>
                <option value="OTHER">OTHER</option>
              </select>
              <span class="tag">Projected?</span>
              <select id="ex_proj" style="min-width:120px">
                <option value="FALSE">FALSE</option>
                <option value="TRUE">TRUE</option>
              </select>
              <button class="btn bad" id="ex_stage">Stage Expense</button>
            </div>
            <div class="miniHelp">
              Expenses reduce the selected account balance and category remaining (after you paste into Transactions).
              Amount is stored negative.
            </div>
          </div>

          <div class="card">
            <div class="kLabel">Category Budgets (Dashboard) + Spent (Transactions.category)</div>
            <div id="cat_list"></div>
          </div>
        </div>

        <!-- TRIPS -->
        <div class="panel" data-panel="trips" style="display:none">
          <div class="card">
            <div class="kLabel">Trips (from Sheet Trips tab)</div>
            <div class="miniHelp">
              Phase 3 will allocate fuel/lodging to categories. For now we read Trip Total.
            </div>
            <div id="trip_list"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG — YOUR SHEET SOURCES
   ========================= */

// Existing working CSV endpoints from your baseline:
const TRIPS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=2037449837&single=true&output=csv";
const TRANSACTIONS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=1140620863&single=true&output=csv";
const GOALS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=948171494&single=true&output=csv";

// Your provided pubhtml base (we resolve gid for Accounts & Dashboard by sheet name):
const SHEET_PUBHTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pubhtml";

// Names must match your sheet tab names:
const TAB_ACCOUNTS = "Accounts";
const TAB_DASHBOARD = "Dashboard";

/* =========================
   STATE
   ========================= */
const now = new Date();
const BASE_YEAR = now.getFullYear();

const LS_KEY = "af_studio_v2";
const state = loadState() || {
  year: BASE_YEAR,
  goalsByYear: {},

  // sheet-derived
  accounts: [],    // {account_id, name, include_in, _goal}
  dashboardCats: [], // {name, budget}
  trips: [],       // {name, total}
  txns: [],        // full schema

  // scenario delta (UI only)
  scenario: { items: [] }, // {type:'cost'|'income', amt, note, id}

  // staged commit pack rows
  commits: [] // strings
};

function loadState(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

function isoDate(d){
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function money(n){
  const v = Number(n||0);
  const sign = v < 0 ? "-" : "";
  return sign + "$" + Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function uid(){
  // deterministic-ish unique id for commit rows (safe enough for paste staging)
  return Math.random().toString(16).slice(2,10).toUpperCase() + "-" + Date.now().toString(16).toUpperCase();
}

/* =========================
   CSV helpers
   ========================= */
function parseCSV(text){
  // simple CSV parser (no quoted commas). Works with your exports.
  const lines = text.trim().split(/\r?\n/);
  return lines.map(l => l.split(","));
}
async function fetchText(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("Fetch failed: " + res.status);
  return res.text();
}
function safeYear(dateStr){
  const d = new Date(dateStr);
  if(!isNaN(d)) return d.getFullYear();
  const m = String(dateStr||"").match(/(\d{4})/);
  return m ? Number(m[1]) : null;
}

/* =========================
   pubhtml -> gid resolver (by tab name)
   ========================= */
let _gidCache = null;

async function resolveGidMap(){
  if(_gidCache) return _gidCache;

  const html = await fetchText(SHEET_PUBHTML);
  // Google published HTML contains sheet tabs with gids.
  // We'll extract occurrences of "gid=NNN" near the sheet name.
  // This is intentionally forgiving (Google HTML changes).
  const map = {};

  // Approach:
  // 1) Find all "gid=123" occurrences
  // 2) For each, look back a bit for the sheet name in the surrounding chunk
  const re = /gid=(\d+)/g;
  let m;
  const hits = [];
  while((m = re.exec(html)) !== null){
    hits.push({ gid: m[1], idx: m.index });
  }

  const wantNames = [TAB_ACCOUNTS, TAB_DASHBOARD];

  for(const hit of hits){
    const start = Math.max(0, hit.idx - 500);
    const end = Math.min(html.length, hit.idx + 500);
    const chunk = html.slice(start, end);

    for(const name of wantNames){
      if(map[name]) continue;
      // check if name appears near this gid hit
      const nameRe = new RegExp(escapeRegExp(name), "i");
      if(nameRe.test(chunk)){
        map[name] = hit.gid;
      }
    }
  }

  _gidCache = map;
  return map;
}

function pubCsvFromGid(gid){
  // convert pubhtml base to pub?gid=...&single=true&output=csv
  // If SHEET_PUBHTML ends with /pubhtml, replace.
  const base = SHEET_PUBHTML.replace(/\/pubhtml.*$/i, "/pub");
  return `${base}?gid=${gid}&single=true&output=csv`;
}

function escapeRegExp(s){
  return String(s).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

/* =========================
   Sheet loaders
   ========================= */
async function loadSheetData(){
  // Resolve Accounts + Dashboard CSV urls dynamically
  const gidMap = await resolveGidMap();

  const missing = [];
  if(!gidMap[TAB_ACCOUNTS]) missing.push(TAB_ACCOUNTS);
  if(!gidMap[TAB_DASHBOARD]) missing.push(TAB_DASHBOARD);

  if(missing.length){
    // still allow app to run, but show a warning
    showSchemaWarn(`Could not resolve gid for: ${missing.join(", ")}. Open Publish-to-web and ensure tab names match exactly: "${TAB_ACCOUNTS}", "${TAB_DASHBOARD}".`);
  } else {
    hideSchemaWarn();
  }

  const ACCOUNTS_CSV = gidMap[TAB_ACCOUNTS] ? pubCsvFromGid(gidMap[TAB_ACCOUNTS]) : null;
  const DASHBOARD_CSV = gidMap[TAB_DASHBOARD] ? pubCsvFromGid(gidMap[TAB_DASHBOARD]) : null;

  const tasks = [
    fetchText(TRIPS_CSV),
    fetchText(TRANSACTIONS_CSV),
    fetchText(GOALS_CSV)
  ];

  if(ACCOUNTS_CSV) tasks.push(fetchText(ACCOUNTS_CSV));
  if(DASHBOARD_CSV) tasks.push(fetchText(DASHBOARD_CSV));

  const results = await Promise.all(tasks);

  // Unpack known first 3
  const tTrips = results[0];
  const tTxns  = results[1];
  const tGoals = results[2];

  const tAccounts = ACCOUNTS_CSV ? results[3] : null;
  const tDashboard = DASHBOARD_CSV ? results[ACCOUNTS_CSV ? 4 : 3] : null;

  // Trips
  {
    const rows = parseCSV(tTrips);
    const head = rows.shift().map(h=>h.trim());
    const nameIdx = head.indexOf("Trip Name") >= 0 ? head.indexOf("Trip Name") : head.indexOf("name");
    const totalIdx = head.indexOf("Trip Total") >= 0 ? head.indexOf("Trip Total") : head.indexOf("total");

    state.trips = rows
      .map(r => ({
        name: (r[nameIdx]||"").trim(),
        total: Number(r[totalIdx]||0)
      }))
      .filter(x => x.name.length);
  }

  // Transactions (full schema, normalize weird " type")
  {
    const rows = parseCSV(tTxns);
    const head = rows.shift().map(h=>String(h||"").trim());
    const idx = {
      txn_id: head.indexOf("txn_id"),
      date: head.indexOf("date"),
      account_id: head.indexOf("account_id"),
      amount: head.indexOf("amount"),
      type: head.indexOf("type") >= 0 ? head.indexOf("type") : head.indexOf("type".trim()),
      projected: head.indexOf("projected"),
      category: head.indexOf("category")
    };

    const missingCols = Object.entries(idx).filter(([k,v]) => v < 0).map(([k])=>k);
    if(missingCols.length){
      showSchemaWarn(`Transactions missing columns: ${missingCols.join(", ")}. Header must include txn_id,date,account_id,amount,type,projected,category.`);
    }

    state.txns = rows.map(r => ({
      txn_id: r[idx.txn_id],
      date: r[idx.date],
      year: safeYear(r[idx.date]),
      account_id: r[idx.account_id],
      amount: Number(r[idx.amount]||0),
      type: r[idx.type],
      projected: String(r[idx.projected]||"").trim().toUpperCase(), // TRUE/FALSE
      category: (r[idx.category]||"").trim()
    })).filter(x => Number.isFinite(x.amount) && x.year);
  }

  // Goals
  {
    const rows = parseCSV(tGoals);
    rows.shift(); // header
    const map = {};
    for(const r of rows){
      const y = Number(r[0]||0);
      const g = Number(r[1]||0);
      if(y) map[y] = g;
    }
    // merge
    for(const [yStr,g] of Object.entries(map)){
      const y = Number(yStr);
      if(state.goalsByYear[y] === undefined || state.goalsByYear[y] === null || state.goalsByYear[y] === 0){
        state.goalsByYear[y] = g;
      }
    }
    if(!state.goalsByYear[state.year]){
      state.goalsByYear[state.year] = map[state.year] || 9500;
    }
  }

  // Accounts
  if(tAccounts){
    const rows = parseCSV(tAccounts);
    const head = rows.shift().map(h=>String(h||"").trim());
    const idx = {
      account_id: head.indexOf("account_id"),
      name: head.indexOf("name"),
      include_in: head.indexOf("include_in"),
      _goal: head.indexOf("_goal")
    };

    state.accounts = rows
      .map(r => ({
        account_id: (r[idx.account_id]||"").trim(),
        name: (r[idx.name]||"").trim(),
        include_in: (r[idx.include_in]||"").trim(),
        _goal: (r[idx._goal]||"").trim()
      }))
      .filter(a => a.name.length);

    // If account_id missing in sheet, apply deterministic mapping for known names
    for(const a of state.accounts){
      if(!a.account_id){
        a.account_id = inferAccountId(a.name);
      }
    }
  }

  // Dashboard categories
  if(tDashboard){
    state.dashboardCats = parseDashboardCategories(tDashboard);
  }

  saveState();
}

function inferAccountId(name){
  const n = String(name||"").toLowerCase();
  if(n.includes("checking")) return "CHK";
  if(n.includes("savings")) return "SAV";
  if(n.includes("gift")) return "GFT";
  if(n.includes("cash")) return "CSH";
  if(n.includes("other")) return "OTH";
  return (name||"").slice(0,3).toUpperCase() || "UNK";
}

function parseDashboardCategories(csvText){
  const rows = parseCSV(csvText);
  // Typically two columns: Account,Balance
  // Find the row containing "Year Projection Section" in col0
  let startIdx = -1;
  for(let i=0;i<rows.length;i++){
    const a = (rows[i][0]||"").trim();
    if(a.toLowerCase().includes("year projection section")){
      startIdx = i+1;
      break;
    }
  }
  if(startIdx < 0){
    // fallback: start around 15th row as you described
    startIdx = 15;
  }

  const cats = [];
  for(let i=startIdx;i<rows.length;i++){
    const name = (rows[i][0]||"").trim();
    const valRaw = (rows[i][1]||"").trim();

    if(!name) continue;

    // Stop if we hit a totally different section (optional)
    // Keep going; we'll just filter numeric budgets.
    const budget = Number(valRaw);
    if(Number.isFinite(budget) && valRaw !== ""){
      // exclude obvious rollups if present
      const lower = name.toLowerCase();
      if(lower.includes("total projected") || lower.includes("difference") || lower === "goal") continue;
      cats.push({ name, budget });
    }
  }

  // Deduplicate by name (keep last)
  const map = {};
  for(const c of cats) map[c.name] = c;
  return Object.values(map);
}

/* =========================
   Computation Engine
   ========================= */
function isProjectedFlag(v){
  return String(v||"").trim().toUpperCase() === "TRUE";
}

function accountBalances({includeProjected}){
  const m = {};
  for(const a of state.accounts){
    m[a.account_id] = 0;
  }

  for(const t of state.txns){
    if(t.year !== state.year) continue;
    if(!includeProjected && isProjectedFlag(t.projected)) continue;
    if(!m.hasOwnProperty(t.account_id)) m[t.account_id] = 0;
    m[t.account_id] += Number(t.amount||0);
  }
  return m;
}

function totalFund({includeProjected}){
  const bal = accountBalances({includeProjected});
  let sum = 0;

  // include_in rules:
  // include_in blank => include
  // include_in "FALSE" => exclude
  for(const a of state.accounts){
    const inc = String(a.include_in||"").trim().toUpperCase();
    if(inc === "FALSE") continue;
    sum += Number(bal[a.account_id]||0);
  }

  // If accounts list is missing, fallback to sum of all balances seen in txns
  if(!state.accounts.length){
    sum = Object.values(bal).reduce((s,v)=>s+v,0);
  }

  return sum;
}

function reservedTotal(){
  return state.dashboardCats.reduce((s,c)=>s + Number(c.budget||0), 0);
}

function categorySpent(name, {includeProjected}){
  let sum = 0;
  for(const t of state.txns){
    if(t.year !== state.year) continue;
    if(!includeProjected && isProjectedFlag(t.projected)) continue;
    if(t.category === name && Number(t.amount) < 0){
      sum += Math.abs(Number(t.amount||0));
    }
  }
  return sum;
}

function scenarioNet(){
  return state.scenario.items.reduce((s,it)=> s + (it.type==="income" ? Number(it.amt||0) : -Number(it.amt||0)), 0);
}

function projectedYearEnd(){
  // projected year-end as "include projected transactions" + scenario delta
  const projFund = totalFund({includeProjected:true});
  return projFund + scenarioNet();
}

/* =========================
   UI bindings
   ========================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function setView(view){
  $$(".navBtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.view===view);
  });
  $$("[data-panel]").forEach(p=>{
    p.style.display = (p.dataset.panel===view) ? "block" : "none";
  });
}

function renderYears(){
  const years = [BASE_YEAR, BASE_YEAR+1, BASE_YEAR+2];
  const host = $("#yearPills");
  host.innerHTML = "";
  for(const y of years){
    const b = document.createElement("button");
    b.className = "pill" + (state.year===y ? " active" : "");
    b.textContent = y;
    b.onclick = () => { state.year = y; if(!state.goalsByYear[y]) state.goalsByYear[y]=0; saveState(); renderAll(); };
    host.appendChild(b);
  }
}

function renderGoal(){
  const g = state.goalsByYear[state.year] ?? 0;
  $("#goalInput").value = g;
}

function renderDashboard(){
  const goal = Number(state.goalsByYear[state.year]||0);

  const total = totalFund({includeProjected:false});
  const reserved = reservedTotal();
  const free = total - reserved;

  const projYE = projectedYearEnd();
  const delta = projYE - goal;

  $("#k_totalFund").textContent = money(total);
  $("#k_reserved").textContent = money(reserved);
  $("#k_free").textContent = money(free);

  $("#k_projSub").innerHTML = `Projected Year-End: <b>${money(projYE)}</b> • ` +
    (goal>0
      ? (delta>=0 ? `<span class="good">Above floor by ${money(delta)}</span>` : `<span class="bad">Below floor by ${money(Math.abs(delta))}</span>`)
      : `<span class="warn">Set a goal floor to track buffer</span>`
    );

  // bar: proj/goal capped 0..100
  const pct = goal>0 ? Math.max(0, Math.min(100, (projYE/goal)*100)) : 0;
  const bar = $("#goalBar");
  bar.style.width = pct + "%";
  bar.style.background = (goal>0 && delta<0) ? "var(--bad)" : "var(--good)";

  $("#sim_net").textContent = money(scenarioNet());
  renderCommitPack();
}

function renderCommitPack(){
  const box = $("#commit_pack");
  if(!state.commits.length){
    box.textContent = "(no staged commits yet)";
    return;
  }
  const header = "txn_id,date,account_id,amount,type,projected,category";
  box.textContent = [header].concat(state.commits).join("\n");
}

function renderAccounts(){
  const host = $("#acct_list");
  host.innerHTML = "";

  const actual = accountBalances({includeProjected:false});
  const proj = accountBalances({includeProjected:true});

  const list = state.accounts.length ? state.accounts : Object.keys(actual).map(id=>({account_id:id, name:id, include_in:"", _goal:""}));

  for(const a of list){
    const act = Number(actual[a.account_id]||0);
    const prj = Number(proj[a.account_id]||0);

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(a.name)} <span class="tag">${escapeHtml(a.account_id)}</span></div>
        <div class="rowMeta">Actual: <b>${money(act)}</b> • Projected: <b>${money(prj)}</b></div>
      </div>
      <div class="rowRight">
        <span class="tag">${String(a.include_in||"").trim().toUpperCase()==="FALSE" ? "Excluded" : "Included"}</span>
      </div>
    `;
    host.appendChild(row);
  }

  // Transfer dropdowns
  const fromSel = $("#tr_from");
  const toSel = $("#tr_to");
  const exAcct = $("#ex_account");

  const options = list.map(a => ({ id:a.account_id, label:`${a.name} (${a.account_id})` }));

  fillSelect(fromSel, options, fromSel.value);
  fillSelect(toSel, options, toSel.value);
  fillSelect(exAcct, options, exAcct.value);

  // default dates
  if(!$("#tr_date").value) $("#tr_date").value = isoDate(new Date());
}

function renderCategories(){
  // category dropdown
  const catSel = $("#ex_category");
  const opts = state.dashboardCats.map(c => ({ id:c.name, label:`${c.name} (Budget ${money(c.budget)})` }));
  fillSelect(catSel, opts, catSel.value);

  if(!$("#ex_date").value) $("#ex_date").value = isoDate(new Date());

  const host = $("#cat_list");
  host.innerHTML = "";

  if(!state.dashboardCats.length){
    host.innerHTML = `<div class="miniHelp">No category budgets found in Dashboard export. Ensure the Dashboard tab includes a "Year Projection Section" line and numeric budgets in column B.</div>`;
    return;
  }

  for(const c of state.dashboardCats){
    const spent = categorySpent(c.name, {includeProjected:false});
    const remaining = Number(c.budget||0) - Number(spent||0);
    const pct = c.budget>0 ? Math.max(0, Math.min(100, (spent/c.budget)*100)) : 0;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div style="min-width:0">
        <div class="rowTitle">${escapeHtml(c.name)}</div>
        <div class="rowMeta">Budget ${money(c.budget)} • Spent ${money(spent)} • Remaining <span class="${remaining>=0?'good':'bad'}">${money(remaining)}</span></div>
        <div class="barWrap" style="margin-top:8px"><div class="bar" style="width:${pct}%;background:${remaining>=0?'var(--good)':'var(--bad)'}"></div></div>
      </div>
      <div class="rowRight">
        <button class="btn primary" data-stagecat="${escapeAttr(c.name)}">Stage Remaining as Reserve (optional)</button>
      </div>
    `;
    host.appendChild(row);
  }

  host.querySelectorAll("button[data-stagecat]").forEach(b=>{
    b.onclick = ()=>{
      const name = b.getAttribute("data-stagecat");
      const cat = state.dashboardCats.find(x=>x.name===name);
      if(!cat) return;
      // reserve staging is optional; we stage a projected negative expense to hold the budget
      const acct = $("#ex_account").value || (state.accounts[0]?.account_id || "CHK");
      const amt = Math.abs(Number(cat.budget||0));
      stageCommitRow({
        date: isoDate(new Date()),
        account_id: acct,
        amount: -amt,
        type: "RESERVE",
        projected: "TRUE",
        category: name
      });
      saveState(); renderAll();
    };
  });
}

function renderTrips(){
  const host = $("#trip_list");
  host.innerHTML = "";
  if(!state.trips.length){
    host.innerHTML = `<div class="miniHelp">No trips loaded from sheet yet. Check your Trips CSV link.</div>`;
    return;
  }

  for(const tr of state.trips){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(tr.name)}</div>
        <div class="rowMeta">Trip Total (sheet): ${money(tr.total)}</div>
      </div>
      <div class="rowRight">
        <span class="tag">${money(tr.total)}</span>
      </div>
    `;
    host.appendChild(row);
  }
}

function renderAll(){
  renderYears();
  renderGoal();
  renderDashboard();
  renderAccounts();
  renderCategories();
  renderTrips();
}

/* =========================
   Actions — staging commits
   ========================= */
function stageCommitRow({date, account_id, amount, type, projected, category}){
  const txn_id = "TXN-" + uid();
  const line = [
    txn_id,
    date,
    account_id,
    Number(amount).toFixed(2),
    type || "MANUAL",
    (String(projected||"FALSE").trim().toUpperCase()==="TRUE" ? "TRUE" : "FALSE"),
    (category || "")
  ].join(",");

  state.commits.push(line);
}

function stageTransfer(){
  const from = $("#tr_from").value;
  const to = $("#tr_to").value;
  const amt = Math.abs(Number($("#tr_amt").value||0));
  const date = $("#tr_date").value || isoDate(new Date());
  const projected = $("#tr_proj").value || "FALSE";

  if(!from || !to || !amt){
    alert("Transfer requires From, To, and Amount.");
    return;
  }
  if(from === to){
    alert("From and To cannot be the same account.");
    return;
  }

  // two deterministic rows
  stageCommitRow({ date, account_id: from, amount: -amt, type:"TRANSFER", projected, category:"TRANSFER" });
  stageCommitRow({ date, account_id: to, amount: amt, type:"TRANSFER", projected, category:"TRANSFER" });

  $("#tr_amt").value = "";
  saveState(); renderAll();
}

function stageExpense(){
  const acct = $("#ex_account").value;
  const cat = $("#ex_category").value;
  const amt = Math.abs(Number($("#ex_amt").value||0));
  const date = $("#ex_date").value || isoDate(new Date());
  const type = $("#ex_type").value || "EXPENSE";
  const projected = $("#ex_proj").value || "FALSE";

  if(!acct || !cat || !amt){
    alert("Expense requires Account, Category, and Amount.");
    return;
  }

  stageCommitRow({ date, account_id: acct, amount: -amt, type, projected, category: cat });
  $("#ex_amt").value = "";
  saveState(); renderAll();
}

/* =========================
   Scenario controls
   ========================= */
function addScenario(type){
  const amt = Number($("#sim_amount").value||0);
  if(!amt) return;
  const note = $("#sim_note").value || "";
  state.scenario.items.push({ id: uid(), type, amt: Math.abs(amt), note });
  $("#sim_amount").value = "";
  $("#sim_note").value = "";
  saveState(); renderAll();
}

/* =========================
   Utilities
   ========================= */
function fillSelect(sel, items, keepValue){
  const prev = keepValue || sel.value;
  sel.innerHTML = "";
  for(const it of items){
    const opt = document.createElement("option");
    opt.value = it.id;
    opt.textContent = it.label;
    sel.appendChild(opt);
  }
  if(prev && items.some(x=>x.id===prev)) sel.value = prev;
}

function escapeHtml(s){
  return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}
function escapeAttr(s){
  return String(s||"").replaceAll('"',"&quot;");
}

function showSchemaWarn(msg){
  const el = $("#schemaWarn");
  el.style.display = "block";
  el.textContent = msg;
}
function hideSchemaWarn(){
  const el = $("#schemaWarn");
  el.style.display = "none";
  el.textContent = "";
}

/* =========================
   Init / Wiring
   ========================= */
function wireUI(){
  // nav
  $$(".navBtn").forEach(b=>{
    b.onclick = ()=> setView(b.dataset.view);
  });

  // goal input
  $("#goalInput").addEventListener("change", ()=>{
    state.goalsByYear[state.year] = Number($("#goalInput").value||0);
    saveState(); renderAll();
  });

  // refresh
  $("#refreshBtn").onclick = async ()=>{
    $("#refreshBtn").textContent = "Refreshing…";
    try{
      await loadSheetData();
      renderAll();
    }catch(e){
      alert("Sheet refresh failed.\n\n" + e.message);
    } finally {
      $("#refreshBtn").textContent = "Refresh Sheet";
    }
  };

  // scenario
  $("#sim_add_cost").onclick = ()=> addScenario("cost");
  $("#sim_add_income").onclick = ()=> addScenario("income");
  $("#sim_clear").onclick = ()=>{
    state.scenario.items = [];
    saveState(); renderAll();
  };

  // transfers
  $("#tr_stage").onclick = ()=> stageTransfer();

  // expense staging
  $("#ex_stage").onclick = ()=> stageExpense();

  // commit pack buttons
  $("#commit_clear").onclick = ()=>{
    state.commits = [];
    saveState(); renderAll();
  };
  $("#commit_copy").onclick = async ()=>{
    const header = "txn_id,date,account_id,amount,type,projected,category";
    const text = (!state.commits.length) ? header : [header].concat(state.commits).join("\n");
    try{
      await navigator.clipboard.writeText(text);
      $("#commit_copy").textContent = "Copied!";
      setTimeout(()=> $("#commit_copy").textContent="Copy", 900);
    }catch{
      alert("Copy failed (browser blocked clipboard). You can manually select and copy from the box.");
    }
  };
}

(async function init(){
  wireUI();
  setView("dashboard");

  // default goal
  if(!state.goalsByYear[state.year]) state.goalsByYear[state.year] = 9500;

  // load sheet
  try{
    await loadSheetData();
  }catch(e){
    console.warn(e);
    showSchemaWarn("Initial sheet load failed. Use Refresh Sheet after confirming Publish-to-web is enabled.");
  }

  saveState();
  renderAll();
})();
</script>
</body>
</html>
