<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure Fund</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --panel:#101823;
      --card:#121c2a;
      --line:rgba(255,255,255,.10);
      --text:#e8eef7;
      --muted:#9fb0c9;
      --muted2:#7f8aa3;

      --good:#3fd28c;
      --bad:#ff5d5d;
      --warn:#ffcc66;
      --accent:#7dd3fc;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(154,230,180,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:26px 22px 42px;}
    .top{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{display:flex;flex-direction:column;gap:6px;}
    .title h1{margin:0;font-weight:800;letter-spacing:-.02em;font-size:28px}
    .subtitle{color:var(--muted);font-size:13px}

    .pillRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
    .pill.active{
      background:linear-gradient(180deg, rgba(125,211,252,.18), rgba(125,211,252,.10));
      border-color:rgba(125,211,252,.35);
    }

    .layout{
      display:grid;
      grid-template-columns: 250px 1fr;
      gap:14px;
      margin-top:14px;
    }
    .nav{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      height: fit-content;
    }
    .navBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
      margin-bottom:8px;
      text-align:left;
    }
    .navBtn:hover{background:rgba(255,255,255,.04)}
    .navBtn.active{
      background:rgba(125,211,252,.10);
      border-color:rgba(125,211,252,.25);
    }
    .navLeft{display:flex;align-items:center;gap:10px}
    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .navBtn.active .dot{background:rgba(125,211,252,.7); box-shadow:0 0 0 3px rgba(125,211,252,.15)}
    .navLabel{font-weight:800;font-size:13px}
    .navHint{color:var(--muted2);font-size:12px}

    .main{min-width:0;}
    .panel{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }

    .grid3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 1020px){
      .layout{grid-template-columns: 1fr}
      .nav{position:relative;top:auto}
      .grid3{grid-template-columns: 1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:14px;
      min-width:0;
    }
    .kLabel{color:var(--muted);font-size:12px;letter-spacing:.02em;text-transform:uppercase}
    /* Fix the cut-off: clamp prevents huge numbers from overflowing */
    .kVal{font-weight:900;margin-top:6px;letter-spacing:-.02em;font-size:clamp(22px, 3.2vw, 34px);line-height:1.05;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .kSub{margin-top:6px;color:var(--muted2);font-size:12px}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    .row{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row:last-child{border-bottom:none}
    .rowTitle{font-weight:800;font-size:14px}
    .rowMeta{color:var(--muted2);font-size:12px;margin-top:2px}
    .rowRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{
      border-color:rgba(125,211,252,.35);
      background:rgba(125,211,252,.12);
    }
    .btn.good{
      border-color:rgba(63,210,140,.35);
      background:rgba(63,210,140,.10);
    }
    .btn.bad{
      border-color:rgba(255,93,93,.35);
      background:rgba(255,93,93,.10);
    }

    .tag{
      font-family:var(--mono);
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .tag.strong{color:var(--text)}
    .tag.good{color:var(--good);border-color:rgba(63,210,140,.35);background:rgba(63,210,140,.08)}
    .tag.bad{color:var(--bad);border-color:rgba(255,93,93,.35);background:rgba(255,93,93,.08)}
    .tag.warn{color:var(--warn);border-color:rgba(255,204,102,.35);background:rgba(255,204,102,.08)}

    .fieldRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input, select{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-size:13px;
      outline:none;
      min-width: 140px;
    }
    input:focus, select:focus{border-color:rgba(125,211,252,.35)}

    .miniHelp{color:var(--muted2);font-size:12px;margin-top:8px;line-height:1.45}

    /* Category accordion */
    .catCard{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      overflow:hidden;
      margin-top:10px;
    }
    .catCard.badgeRed{border-color:rgba(255,93,93,.45); box-shadow:0 0 0 1px rgba(255,93,93,.18) inset;}
    .catHead{
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .catHead:hover{background:rgba(255,255,255,.04)}
    .catTitleWrap{min-width:0}
    .catName{font-weight:900;letter-spacing:-.01em}
    .catSmall{margin-top:3px;color:var(--muted2);font-size:12px}
    .catBadges{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .catBody{
      display:none;
      border-top:1px solid rgba(255,255,255,.06);
      padding:12px 12px 10px;
      background:rgba(0,0,0,.15);
    }
    .catBody.open{display:block}
    .groupTitle{
      margin:12px 0 6px;
      font-weight:900;
      font-size:12px;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .itemRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 8px;
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px;
      margin-bottom:8px;
      background:rgba(255,255,255,.02);
    }
    .itemLeft{min-width:0}
    .itemName{font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:520px;}
    .itemMeta{color:var(--muted2); font-size:12px; margin-top:3px}
    .itemRight{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .strike{ text-decoration: line-through; opacity:.85 }
    .fade{ opacity:.85 }

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      background:rgba(0,0,0,.70);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:var(--shadow);
      font-size:13px;
      color:var(--text);
      display:none;
      max-width: 420px;
    }
    .toast.show{display:block}
    .toast .t2{color:var(--muted2);font-size:12px;margin-top:4px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Adventure Fund</h1>
        <div class="subtitle">Sheet-backed fund + category planning (deterministic)</div>
      </div>

      <div class="pillRow">
        <div class="pillRow" id="yearPills"></div>
        <span class="tag">Target (Goal Floor)</span>
        <input id="goalInput" type="number" step="1" style="width:150px" />
        <button class="btn primary" id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="layout">
      <div class="nav">
        <button class="navBtn" data-view="dashboard">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Dashboard</div><div class="navHint">Totals + target gap</div></div></div>
        </button>
        <button class="navBtn" data-view="accounts">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Accounts</div><div class="navHint">Balances + transfer</div></div></div>
        </button>
        <button class="navBtn active" data-view="categories">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Categories</div><div class="navHint">Budget + items</div></div></div>
        </button>
        <button class="navBtn" data-view="trips">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Trips</div><div class="navHint">Fuel + lodging</div></div></div>
        </button>

        <div style="height:10px"></div>
        <div class="miniHelp">
          <b>Rule:</b> if <b>Commit + Purchased</b> exceeds the category budget, the category turns <span class="bad"><b>RED</b></span> (allowed, not blocked).
        </div>
      </div>

      <div class="main">
        <!-- DASHBOARD -->
        <div class="panel" data-panel="dashboard" style="display:none">
          <div class="grid3">
            <div class="card">
              <div class="kLabel">Total Fund</div>
              <div class="kVal" id="k_total">$0</div>
              <div class="kSub">sum of all account balances</div>
            </div>
            <div class="card">
              <div class="kLabel">Reserved</div>
              <div class="kVal" id="k_reserved">$0</div>
              <div class="kSub">sum of category budgets (selected year)</div>
            </div>
            <div class="card">
              <div class="kLabel">Available (Unallocated)</div>
              <div class="kVal" id="k_free">$0</div>
              <div class="kSub">Total Fund − Reserved</div>
            </div>
          </div>

          <div class="grid3">
            <div class="card">
              <div class="kLabel">Target Gap</div>
              <div class="kVal" id="k_gap">$0</div>
              <div class="kSub" id="k_gap_sub">Projected − Target</div>
            </div>
            <div class="card">
              <div class="kLabel">Category Items</div>
              <div class="kVal" id="k_items">0</div>
              <div class="kSub">total items (all categories)</div>
            </div>
            <div class="card">
              <div class="kLabel">Trip Total (Projected)</div>
              <div class="kVal" id="k_trip_total">$0</div>
              <div class="kSub">sum of Trip Total (Trips tab)</div>
            </div>
          </div>

          <div class="card">
            <div class="kLabel">Notes</div>
            <div class="miniHelp">
              This dashboard is intentionally simple: <b>Total Fund</b>, <b>Reserved</b>, <b>Available</b>, and your <b>Target Gap</b>.
              Your primary workflow is <b>Categories → Items</b>.
            </div>
          </div>
        </div>

        <!-- ACCOUNTS -->
        <div class="panel" data-panel="accounts" style="display:none">
          <div class="card">
            <div class="kLabel">Account Balances</div>
            <div id="acct_list"></div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div class="kLabel">Transfer</div>
            <div class="fieldRow">
              <select id="xfer_from" style="min-width:180px"></select>
              <select id="xfer_to" style="min-width:180px"></select>
              <input id="xfer_amt" type="number" step="0.01" placeholder="Amount" style="width:160px" />
              <input id="xfer_memo" placeholder="Memo (optional)" style="min-width:240px" />
              <button class="btn primary" id="xfer_btn">Transfer</button>
            </div>
            <div class="miniHelp">
              Transfers move money between accounts and should not change Total Fund.
              (If your backend is configured to also write transaction rows, it will.)
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div class="kLabel">Accurizer (Set Actual Balances)</div>
            <div class="miniHelp">
              Enter what you actually have right now. This corrects small drift (interest, rounding, unplanned small deltas).
            </div>
            <div id="accu_list"></div>
            <div class="fieldRow">
              <button class="btn good" id="accu_save">Set Actual</button>
            </div>
          </div>
        </div>

        <!-- CATEGORIES -->
        <div class="panel" data-panel="categories">
          <div class="card">
            <div class="kLabel">Categories</div>
            <div class="miniHelp">
              Click a category to expand. Items are grouped by <b>commit</b>, <b>purchased</b>, <b>consider</b>.
              Remaining is calculated as: <b>Budget − (Commit + Purchased)</b>.
            </div>

            <div class="fieldRow">
              <input id="cat_new_name" placeholder="New category name" />
              <input id="cat_new_budget" type="number" step="1" placeholder="Annual budget" style="width:160px" />
              <button class="btn primary" id="cat_add_btn">Add Category</button>
            </div>

            <div id="cat_host" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- TRIPS -->
        <div class="panel" data-panel="trips" style="display:none">
          <div class="card">
            <div class="kLabel">Trips (Sheet)</div>
            <div class="miniHelp">
              This view reads your Trips sheet. Trip creation/editing can be added next (Phase 3).
            </div>
            <div id="trip_host"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><div id="toast_t1"></div><div class="t2" id="toast_t2"></div></div>

<script>
/* =========================
   CONFIG
   ========================= */

/** Your Apps Script Web App endpoint (write-back) */
const WRITEBACK_URL = "https://script.google.com/macros/s/AKfycbwV7C7i2Dj0lepZAGz3jxbRV8gMJT1tLYFJ8Gu_xI0c-HaJ4ehzpPfXxQ5_zAyM3kG9/exec";

/**
 * Google Sheets published CSV endpoints (read)
 * NOTE: gids below are best-effort from what you provided earlier.
 * If any panel says "No data", only THAT gid needs adjusting.
 */
const SHEET_CSV = (gid) => `https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=${gid}&single=true&output=csv`;

// You provided these gids in chat.
// We keep them as constants so it's deterministic and obvious.
const GID_ACTUAL_BALANCES = 1567617658;  // Actual_Balances
const GID_CATEGORY_BUDGETS = 832851607;  // Category_Budgets
const GID_CATEGORY_ITEMS  = 1613648940;  // Category_Items
const GID_TRIPS           = 2037449837;  // Trips
const GID_GOALS           = 1350021405;  // Year_Settings or Goals (depends on your sheet)

const ACTUAL_BALANCES_CSV = SHEET_CSV(GID_ACTUAL_BALANCES);
const CATEGORY_BUDGETS_CSV = SHEET_CSV(GID_CATEGORY_BUDGETS);
const CATEGORY_ITEMS_CSV = SHEET_CSV(GID_CATEGORY_ITEMS);
const TRIPS_CSV = SHEET_CSV(GID_TRIPS);
const GOALS_CSV = SHEET_CSV(GID_GOALS);

/* =========================
   STATE
   ========================= */
const LS_KEY = "af_ui_v2";
const now = new Date();
const BASE_YEAR = now.getFullYear();

const state = loadState() || {
  year: BASE_YEAR,
  goalByYear: {},

  accounts: [],      // {account_id, name, current_balance}
  categories: [],    // {category_id, category_name, annual_budget, year}
  items: [],         // {item_id, category_id, description, planned_cost, year, status}
  trips: [],         // best-effort parsed from sheet

  ui: { openCats: {} } // category_id => bool
};

function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

function money(n){
  const v = Number(n||0);
  const sign = v < 0 ? "-" : "";
  return sign + "$" + Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function toNum(x){
  const v = Number(String(x ?? "").replace(/[$,]/g,"").trim());
  return Number.isFinite(v) ? v : 0;
}

/* =========================
   CSV parsing (robust enough for quoted commas)
   ========================= */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQuotes = false;
  for(let i=0;i<text.length;i++){
    const c = text[i];
    const n = text[i+1];

    if(c === '"' && inQuotes && n === '"'){ cur += '"'; i++; continue; }
    if(c === '"'){ inQuotes = !inQuotes; continue; }

    if(!inQuotes && (c === ",")){
      row.push(cur); cur = ""; continue;
    }
    if(!inQuotes && (c === "\n")){
      row.push(cur);
      rows.push(row);
      row = []; cur = ""; continue;
    }
    if(c === "\r") continue;

    cur += c;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  // trim empty tail
  return rows.filter(r => r.some(cell => String(cell||"").trim().length));
}

async function fetchCSV(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error(`CSV fetch failed (${res.status}) for ${url}`);
  return res.text();
}

/* =========================
   Write-back helper
   ========================= */
async function postJSON(payload){
  const res = await fetch(WRITEBACK_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const txt = await res.text();
  let data = null;
  try{ data = JSON.parse(txt); } catch { data = { ok:false, error: txt }; }
  return data;
}

/* =========================
   Load Sheet Data
   ========================= */
async function loadAll(){
  const [tAccts, tCats, tItems, tTrips, tGoals] = await Promise.all([
    fetchCSV(ACTUAL_BALANCES_CSV).catch(()=> ""),
    fetchCSV(CATEGORY_BUDGETS_CSV).catch(()=> ""),
    fetchCSV(CATEGORY_ITEMS_CSV).catch(()=> ""),
    fetchCSV(TRIPS_CSV).catch(()=> ""),
    fetchCSV(GOALS_CSV).catch(()=> "")
  ]);

  // Accounts
  if(tAccts){
    const rows = parseCSV(tAccts);
    const head = rows.shift().map(h=>h.trim());
    const idxId = head.indexOf("account_id");
    const idxName = head.indexOf("name");
    const idxBal = head.indexOf("current_balance");
    state.accounts = rows.map(r => ({
      account_id: (r[idxId]||"").trim(),
      name: (r[idxName]||"").trim(),
      current_balance: toNum(r[idxBal])
    })).filter(a => a.account_id && a.name);
  }

  // Category Budgets
  if(tCats){
    const rows = parseCSV(tCats);
    const head = rows.shift().map(h=>h.trim());
    const idxId = head.indexOf("category_id");
    const idxName = head.indexOf("category_name");
    const idxBud = head.indexOf("annual_budget");
    const idxYear = head.indexOf("year");
    state.categories = rows.map(r => ({
      category_id: (r[idxId]||"").trim(),
      category_name: (r[idxName]||"").trim(),
      annual_budget: toNum(r[idxBud]),
      year: Number((r[idxYear]||"").trim() || 0)
    })).filter(c => c.category_id && c.category_name);
  }

  // Category Items
  if(tItems){
    const rows = parseCSV(tItems);
    const head = rows.shift().map(h=>h.trim());
    const idxItem = head.indexOf("item_id");
    const idxCat  = head.indexOf("category_id");
    const idxDesc = head.indexOf("description");
    const idxCost = head.indexOf("planned_cost");
    const idxYear = head.indexOf("year");
    const idxStat = head.indexOf("status");
    state.items = rows.map(r => ({
      item_id: (r[idxItem]||"").trim(),
      category_id: (r[idxCat]||"").trim(),
      description: (r[idxDesc]||"").trim(),
      planned_cost: toNum(r[idxCost]),
      year: Number((r[idxYear]||"").trim() || 0),
      status: ((r[idxStat]||"").trim() || "commit").toLowerCase()
    })).filter(it => it.item_id && it.category_id && it.description);
  }

  // Trips (best effort: use Trip Name + Trip Total if present)
  if(tTrips){
    const rows = parseCSV(tTrips);
    const head = rows.shift().map(h=>h.trim());
    const idxName = head.indexOf("Trip Name") >= 0 ? head.indexOf("Trip Name") : head.indexOf("trip_name");
    const idxTotal = head.indexOf("Trip Total") >= 0 ? head.indexOf("Trip Total") : head.indexOf("trip_total");
    state.trips = rows.map(r => ({
      name: (r[idxName]||"").trim(),
      total: toNum(r[idxTotal])
    })).filter(t => t.name);
  }

  // Goals (best effort: expects year,goal_floor OR year,target)
  if(tGoals){
    const rows = parseCSV(tGoals);
    const head = rows.shift().map(h=>h.trim().toLowerCase());
    const yIdx = head.indexOf("year");
    const gIdx = head.indexOf("goal_floor") >= 0 ? head.indexOf("goal_floor") :
                 head.indexOf("target") >= 0 ? head.indexOf("target") :
                 head.indexOf("goal") >= 0 ? head.indexOf("goal") : -1;
    if(yIdx >= 0 && gIdx >= 0){
      for(const r of rows){
        const y = Number((r[yIdx]||"").trim()||0);
        const g = toNum(r[gIdx]);
        if(y) state.goalByYear[y] = g;
      }
    }
  }

  // ensure year + goal
  if(!state.year) state.year = BASE_YEAR;
  if(state.goalByYear[state.year] == null) state.goalByYear[state.year] = state.goalByYear[state.year] ?? 0;

  saveState();
}

/* =========================
   Computations
   ========================= */
function totalFund(){
  return state.accounts.reduce((s,a)=> s + toNum(a.current_balance), 0);
}
function categoriesForYear(year){
  return state.categories.filter(c => Number(c.year) === Number(year));
}
function itemsForYear(year){
  return state.items.filter(i => Number(i.year) === Number(year));
}
function itemsForCategory(year, category_id){
  return itemsForYear(year).filter(i => i.category_id === category_id);
}
function catTotals(year, category_id){
  const its = itemsForCategory(year, category_id);
  let commit=0, purchased=0, consider=0;
  for(const it of its){
    const cost = toNum(it.planned_cost);
    const st = (it.status||"").toLowerCase();
    if(st === "purchased") purchased += cost;
    else if(st === "consider") consider += cost;
    else commit += cost; // default commit
  }
  return { commit, purchased, consider, count: its.length };
}
function reservedTotal(year){
  return categoriesForYear(year).reduce((s,c)=> s + toNum(c.annual_budget), 0);
}
function tripsTotal(){
  return state.trips.reduce((s,t)=> s + toNum(t.total), 0);
}

/* =========================
   UI / Views
   ========================= */
function setView(view){
  $$(".navBtn").forEach(b=> b.classList.toggle("active", b.dataset.view===view));
  $$("[data-panel]").forEach(p=> p.style.display = (p.dataset.panel===view) ? "block" : "none");
}

function renderYears(){
  const years = [BASE_YEAR, BASE_YEAR+1, BASE_YEAR+2];
  const host = $("#yearPills");
  host.innerHTML = "";
  for(const y of years){
    const b = document.createElement("button");
    b.className = "pill" + (state.year===y ? " active" : "");
    b.textContent = y;
    b.onclick = () => { state.year = y; if(state.goalByYear[y]==null) state.goalByYear[y]=0; saveState(); renderAll(); };
    host.appendChild(b);
  }
}

function renderGoal(){
  $("#goalInput").value = Number(state.goalByYear[state.year]||0);
}

function renderDashboard(){
  const t = totalFund();
  const r = reservedTotal(state.year);
  const free = t - r;

  $("#k_total").textContent = money(t);
  $("#k_reserved").textContent = money(r);
  $("#k_free").textContent = money(free);

  const goal = Number(state.goalByYear[state.year]||0);
  // "Projected" for now = Total Fund - Reserved (since income engine wiring is separate)
  const projected = free; // deterministic & honest (no pretending)
  const gap = projected - goal;

  $("#k_gap").textContent = money(gap);
  $("#k_gap_sub").innerHTML = goal>0
    ? (gap>=0 ? `<span class="good">Above target by ${money(gap)}</span>` : `<span class="bad">Below target by ${money(Math.abs(gap))}</span>`)
    : `<span class="warn">Set Target (Goal Floor)</span>`;

  const itemCount = itemsForYear(state.year).length;
  $("#k_items").textContent = String(itemCount);
  $("#k_trip_total").textContent = money(tripsTotal());
}

function renderAccounts(){
  const host = $("#acct_list");
  host.innerHTML = "";

  if(!state.accounts.length){
    host.innerHTML = `<div class="miniHelp">No accounts loaded. Check Actual_Balances CSV gid.</div>`;
  } else {
    for(const a of state.accounts){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <div class="rowTitle">${escapeHtml(a.name)}</div>
          <div class="rowMeta">${escapeHtml(a.account_id)}</div>
        </div>
        <div class="rowRight">
          <span class="tag strong">${money(a.current_balance)}</span>
        </div>
      `;
      host.appendChild(row);
    }
  }

  // transfer dropdowns
  const from = $("#xfer_from");
  const to = $("#xfer_to");
  from.innerHTML = ""; to.innerHTML = "";
  for(const a of state.accounts){
    const o1 = document.createElement("option");
    o1.value = a.account_id; o1.textContent = `${a.name} (${a.account_id})`;
    const o2 = document.createElement("option");
    o2.value = a.account_id; o2.textContent = `${a.name} (${a.account_id})`;
    from.appendChild(o1); to.appendChild(o2);
  }

  // accurizer inputs
  const accu = $("#accu_list");
  accu.innerHTML = "";
  for(const a of state.accounts){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(a.name)}</div>
        <div class="rowMeta">Current: ${money(a.current_balance)}</div>
      </div>
      <div class="rowRight">
        <input data-accu="${escapeAttr(a.account_id)}" type="number" step="0.01" style="width:160px" placeholder="Set actual">
      </div>
    `;
    accu.appendChild(row);
  }
}

function renderTrips(){
  const host = $("#trip_host");
  host.innerHTML = "";
  if(!state.trips.length){
    host.innerHTML = `<div class="miniHelp">No trips loaded from Trips CSV gid.</div>`;
    return;
  }
  for(const t of state.trips){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(t.name)}</div>
        <div class="rowMeta">Trip Total (sheet)</div>
      </div>
      <div class="rowRight">
        <span class="tag strong">${money(t.total)}</span>
      </div>
    `;
    host.appendChild(row);
  }
}

/* =========================
   Categories UI (NEW ENGINE)
   ========================= */
function renderCategories(){
  const host = $("#cat_host");
  host.innerHTML = "";

  const cats = categoriesForYear(state.year);
  if(!cats.length){
    host.innerHTML = `<div class="miniHelp">No categories loaded for ${state.year}. Check Category_Budgets CSV gid.</div>`;
    return;
  }

  for(const c of cats){
    const { commit, purchased, consider, count } = catTotals(state.year, c.category_id);
    const budget = toNum(c.annual_budget);
    const usedHard = commit + purchased;
    const remaining = budget - usedHard;
    const potentialRemaining = budget - (usedHard + consider);
    const over = usedHard > budget;

    const card = document.createElement("div");
    card.className = "catCard" + (over ? " badgeRed" : "");
    const open = !!state.ui.openCats[c.category_id];

    card.innerHTML = `
      <div class="catHead" data-cat-toggle="${escapeAttr(c.category_id)}">
        <div class="catTitleWrap">
          <div class="catName">${escapeHtml(c.category_name)}</div>
          <div class="catSmall">${escapeHtml(c.category_id)} • Items: ${count}</div>
        </div>
        <div class="catBadges">
          <span class="tag strong">Budget ${money(budget)}</span>
          <span class="tag ${over ? "bad" : "good"}">Remaining ${money(remaining)}</span>
          <span class="tag warn">Potential ${money(potentialRemaining)}</span>
          <span class="tag ${over ? "bad" : ""}">${over ? "OVER" : "OK"}</span>
          <span class="tag">${open ? "▲" : "▼"}</span>
        </div>
      </div>
      <div class="catBody ${open ? "open" : ""}" data-cat-body="${escapeAttr(c.category_id)}">
        <div class="row" style="border-bottom:none">
          <div>
            <div class="rowTitle">Summary</div>
            <div class="rowMeta">Remaining = Budget − (Commit + Purchased). Potential includes Consider.</div>
          </div>
          <div class="rowRight">
            <span class="tag">Commit ${money(commit)}</span>
            <span class="tag good">Purchased ${money(purchased)}</span>
            <span class="tag warn">Consider ${money(consider)}</span>
          </div>
        </div>

        <div class="groupTitle">COMMIT</div>
        <div data-group="commit" data-cat="${escapeAttr(c.category_id)}"></div>

        <div class="groupTitle">PURCHASED</div>
        <div data-group="purchased" data-cat="${escapeAttr(c.category_id)}"></div>

        <div class="groupTitle">CONSIDER</div>
        <div data-group="consider" data-cat="${escapeAttr(c.category_id)}"></div>

        <div class="groupTitle">ADD ITEM</div>
        <div class="itemRow">
          <div class="itemLeft" style="flex:1;min-width:0">
            <div class="itemName"><input data-new-desc="${escapeAttr(c.category_id)}" placeholder="Description" style="width:100%"></div>
            <div class="itemMeta">This auto-fills category_id = <span class="tag">${escapeHtml(c.category_id)}</span></div>
          </div>
          <div class="itemRight">
            <input data-new-cost="${escapeAttr(c.category_id)}" type="number" step="1" placeholder="Cost" style="width:140px">
            <select data-new-status="${escapeAttr(c.category_id)}" style="width:150px">
              <option value="commit" selected>commit</option>
              <option value="consider">consider</option>
              <option value="purchased">purchased</option>
            </select>
            <button class="btn primary" data-add-item="${escapeAttr(c.category_id)}">Add</button>
          </div>
        </div>

      </div>
    `;

    host.appendChild(card);

    // render items in groups
    const its = itemsForCategory(state.year, c.category_id);
    const gCommit = card.querySelector(`[data-group="commit"][data-cat="${cssEscape(c.category_id)}"]`);
    const gPurchased = card.querySelector(`[data-group="purchased"][data-cat="${cssEscape(c.category_id)}"]`);
    const gConsider = card.querySelector(`[data-group="consider"][data-cat="${cssEscape(c.category_id)}"]`);

    const by = { commit: [], purchased: [], consider: [] };
    for(const it of its){
      const st = (it.status||"commit").toLowerCase();
      (by[st] || by.commit).push(it);
    }

    gCommit.innerHTML = by.commit.length ? "" : `<div class="miniHelp">No committed items.</div>`;
    gPurchased.innerHTML = by.purchased.length ? "" : `<div class="miniHelp">No purchased items.</div>`;
    gConsider.innerHTML = by.consider.length ? "" : `<div class="miniHelp">No consider items.</div>`;

    for(const it of by.commit) gCommit.appendChild(renderItemRow(it, "commit"));
    for(const it of by.purchased) gPurchased.appendChild(renderItemRow(it, "purchased"));
    for(const it of by.consider) gConsider.appendChild(renderItemRow(it, "consider"));
  }

  // accordion toggles
  host.querySelectorAll("[data-cat-toggle]").forEach(el=>{
    el.onclick = ()=>{
      const id = el.getAttribute("data-cat-toggle");
      state.ui.openCats[id] = !state.ui.openCats[id];
      saveState(); renderCategories(); // re-render category panel only
    };
  });

  // add item
  host.querySelectorAll("button[data-add-item]").forEach(btn=>{
    btn.onclick = async ()=>{
      const catId = btn.getAttribute("data-add-item");
      const descEl = host.querySelector(`input[data-new-desc="${cssEscape(catId)}"]`);
      const costEl = host.querySelector(`input[data-new-cost="${cssEscape(catId)}"]`);
      const statEl = host.querySelector(`select[data-new-status="${cssEscape(catId)}"]`);

      const description = (descEl?.value||"").trim();
      const planned_cost = toNum(costEl?.value||0);
      const status = (statEl?.value||"commit").trim().toLowerCase();

      if(!description || !planned_cost){
        toast("Add Item", "Description and Cost are required.");
        return;
      }

      const item = {
        item_id: `IT-${uid().slice(0,10)}`,
        category_id: catId,
        description,
        planned_cost,
        year: state.year,
        status
      };

      // Write-back
      const r = await postJSON({ action:"upsertCategoryItem", item });
      if(!r.ok){
        toast("Write failed", r.error || "Backend did not accept item write.");
        return;
      }

      toast("Saved", "Item added.");
      await refreshAndRender();
    };
  });
}

function renderItemRow(it, group){
  const row = document.createElement("div");
  row.className = "itemRow";

  const isPurchased = (it.status||"").toLowerCase() === "purchased";
  const isConsider = (it.status||"").toLowerCase() === "consider";

  row.innerHTML = `
    <div class="itemLeft" style="flex:1;min-width:0">
      <div class="itemName ${isPurchased ? "strike" : ""} ${isConsider ? "fade" : ""}">${escapeHtml(it.description)}</div>
      <div class="itemMeta">${escapeHtml(it.item_id)} • ${escapeHtml(it.category_id)} • ${state.year}</div>
    </div>
    <div class="itemRight">
      <span class="tag strong">${money(it.planned_cost)}</span>
      <select data-item-status="${escapeAttr(it.item_id)}" style="width:150px">
        <option value="commit" ${group==="commit" ? "selected":""}>commit</option>
        <option value="consider" ${group==="consider" ? "selected":""}>consider</option>
        <option value="purchased" ${group==="purchased" ? "selected":""}>purchased</option>
      </select>
      <input data-item-cost="${escapeAttr(it.item_id)}" type="number" step="1" style="width:140px" value="${escapeAttr(it.planned_cost)}">
      <button class="btn primary" data-item-save="${escapeAttr(it.item_id)}">Save</button>
      <button class="btn bad" data-item-del="${escapeAttr(it.item_id)}">Delete</button>
    </div>
  `;

  // attach handlers after insert (handled in renderAll with delegation approach)
  setTimeout(()=>wireItemRowHandlers(row, it), 0);
  return row;
}

function wireItemRowHandlers(row, it){
  const sel = row.querySelector(`select[data-item-status="${cssEscape(it.item_id)}"]`);
  const cost = row.querySelector(`input[data-item-cost="${cssEscape(it.item_id)}"]`);
  const btnSave = row.querySelector(`button[data-item-save="${cssEscape(it.item_id)}"]`);
  const btnDel = row.querySelector(`button[data-item-del="${cssEscape(it.item_id)}"]`);

  if(btnSave){
    btnSave.onclick = async ()=>{
      const status = (sel?.value || it.status || "commit").toLowerCase();
      const planned_cost = toNum(cost?.value || it.planned_cost || 0);

      const updated = {
        item_id: it.item_id,
        category_id: it.category_id,
        description: it.description,
        planned_cost,
        year: it.year,
        status
      };

      const r = await postJSON({ action:"upsertCategoryItem", item: updated });
      if(!r.ok){
        toast("Write failed", r.error || "Backend did not accept item write.");
        return;
      }
      toast("Saved", "Item updated.");
      await refreshAndRender();
    };
  }

  if(btnDel){
    btnDel.onclick = async ()=>{
      const r = await postJSON({ action:"deleteCategoryItem", item_id: it.item_id });
      if(!r.ok){
        toast("Delete failed", r.error || "Backend did not accept delete.");
        return;
      }
      toast("Deleted", "Item removed.");
      await refreshAndRender();
    };
  }
}

/* =========================
   Actions: Accounts
   ========================= */
async function doAccurizerSave(){
  const updates = [];
  $("#accu_list").querySelectorAll("input[data-accu]").forEach(inp=>{
    const id = inp.getAttribute("data-accu");
    const v = inp.value;
    if(v !== "" && v != null){
      updates.push({ account_id:id, current_balance: toNum(v) });
    }
  });
  if(!updates.length){
    toast("Accurizer", "No values entered.");
    return;
  }
  const r = await postJSON({ action:"updateBalances", updates });
  if(!r.ok){
    toast("Write failed", r.error || "updateBalances failed");
    return;
  }
  toast("Saved", "Balances updated.");
  await refreshAndRender();
}

async function doTransfer(){
  const from = $("#xfer_from").value;
  const to = $("#xfer_to").value;
  const amt = toNum($("#xfer_amt").value || 0);
  const memo = ($("#xfer_memo").value || "").trim();

  if(!from || !to || !amt || from === to){
    toast("Transfer", "Choose From/To and enter amount. From and To must differ.");
    return;
  }

  const r = await postJSON({
    action:"transfer",
    from_account_id: from,
    to_account_id: to,
    amount: amt,
    memo,
    dateISO: new Date().toISOString().slice(0,10)
  });

  if(!r.ok){
    toast("Transfer failed", r.error || "Backend did not accept transfer.");
    return;
  }
  toast("Transferred", "Refresh completes after sheet updates.");
  $("#xfer_amt").value = "";
  $("#xfer_memo").value = "";
  await refreshAndRender();
}

/* =========================
   Actions: Categories
   ========================= */
async function addCategory(){
  const name = ($("#cat_new_name").value || "").trim();
  const bud = toNum($("#cat_new_budget").value || 0);
  if(!name || !bud){
    toast("Add Category", "Name and Annual Budget required.");
    return;
  }

  // deterministic category_id: first 6 of a hash-like uid (no spaces)
  const category_id = ("C-" + name.replace(/[^a-z0-9]+/gi,"").slice(0,10) + "-" + uid().slice(0,4)).toUpperCase();

  const cat = {
    category_id,
    category_name: name,
    annual_budget: bud,
    year: state.year
  };

  const r = await postJSON({ action:"upsertCategoryBudget", category: cat });
  if(!r.ok){
    toast("Write failed", r.error || "Backend did not accept category write.");
    return;
  }

  $("#cat_new_name").value = "";
  $("#cat_new_budget").value = "";
  toast("Saved", "Category added.");
  await refreshAndRender();
}

/* =========================
   Toast
   ========================= */
let toastTimer = null;
function toast(t1, t2){
  const el = $("#toast");
  $("#toast_t1").textContent = t1 || "";
  $("#toast_t2").textContent = t2 || "";
  el.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> el.classList.remove("show"), 3200);
}

/* =========================
   Rendering master
   ========================= */
function renderAll(){
  renderYears();
  renderGoal();
  renderDashboard();
  renderAccounts();
  renderCategories();
  renderTrips();
}

/* =========================
   UI wiring
   ========================= */
function wireUI(){
  // nav
  $$(".navBtn").forEach(b=>{
    b.onclick = ()=> setView(b.dataset.view);
  });

  // goal
  $("#goalInput").addEventListener("change", ()=>{
    state.goalByYear[state.year] = toNum($("#goalInput").value||0);
    saveState();
    renderDashboard();
  });

  // refresh
  $("#refreshBtn").onclick = refreshAndRender;

  // accounts
  $("#accu_save").onclick = doAccurizerSave;
  $("#xfer_btn").onclick = doTransfer;

  // categories
  $("#cat_add_btn").onclick = addCategory;
}

async function refreshAndRender(){
  $("#refreshBtn").textContent = "Refreshing…";
  try{
    await loadAll();
    renderAll();
  } catch (e){
    toast("Refresh failed", e.message || String(e));
  } finally {
    $("#refreshBtn").textContent = "Refresh";
  }
}

/* =========================
   Escapes
   ========================= */
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function escapeAttr(s){ return String(s||"").replaceAll('"',"&quot;"); }
function cssEscape(s){ return String(s||"").replaceAll('"','\\"'); }

/* =========================
   Boot
   ========================= */
(async function init(){
  wireUI();
  // default view to Categories (your most-used)
  setView("categories");

  // initial load
  await refreshAndRender();
})();
</script>
</body>
</html>
