<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure Fund</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --panel:#101823;
      --card:#121c2a;
      --line:rgba(255,255,255,.08);
      --text:#e8eef7;
      --muted:#9fb0c9;
      --muted2:#7f8aa3;

      --good:#3fd28c;
      --bad:#ff5d5d;
      --warn:#ffcc66;
      --accent:#7dd3fc;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(125,211,252,.06), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:26px 22px 42px;}
    .top{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{display:flex;flex-direction:column;gap:6px;}
    .title h1{margin:0;font-weight:900;letter-spacing:-.02em;font-size:28px}
    .subtitle{color:var(--muted);font-size:13px;line-height:1.35;max-width:820px}

    .yearRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pillRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
    .pill.active{
      background:linear-gradient(180deg, rgba(125,211,252,.18), rgba(125,211,252,.10));
      border-color:rgba(125,211,252,.35);
    }

    .layout{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:14px;
      margin-top:14px;
    }
    .nav{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      height: fit-content;
    }
    .navBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
      margin-bottom:8px;
    }
    .navBtn:hover{background:rgba(255,255,255,.04)}
    .navBtn.active{
      background:rgba(125,211,252,.10);
      border-color:rgba(125,211,252,.25);
    }
    .navLeft{display:flex;align-items:center;gap:10px}
    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .navBtn.active .dot{background:rgba(125,211,252,.85); box-shadow:0 0 0 3px rgba(125,211,252,.15)}
    .navLabel{font-weight:900;font-size:13px}
    .navHint{color:var(--muted2);font-size:12px}

    .main{min-width:0;}
    .panel{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }

    .grid5{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .nav{position:relative;top:auto}
      .grid5{grid-template-columns: 1fr}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:14px;
      min-height:108px;
      overflow:hidden; /* fixes bleed */
    }
    .kLabel{color:var(--muted);font-size:12px;letter-spacing:.02em;text-transform:uppercase}
    .kVal{font-size:30px;font-weight:900;margin-top:6px;letter-spacing:-.02em}
    .kSub{margin-top:6px;color:var(--muted2);font-size:12px;line-height:1.35}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    .barWrap{
      margin-top:10px;
      height:12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar{height:100%;width:0%;background:var(--good);transition:width .25s ease;}

    .row{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row:last-child{border-bottom:none}
    .rowTitle{font-weight:900;font-size:14px}
    .rowMeta{color:var(--muted2);font-size:12px;margin-top:2px;line-height:1.35}
    .rowRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.12);}
    .btn.good{border-color:rgba(63,210,140,.35);background:rgba(63,210,140,.10);}
    .btn.bad{border-color:rgba(255,93,93,.35);background:rgba(255,93,93,.10);}

    .tag{
      font-family:var(--mono);
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.02);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:980px){.twoCol{grid-template-columns:1fr}}

    .fieldRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input, select{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-size:13px;
      outline:none;
      min-width: 140px;
    }
    input:focus, select:focus{border-color:rgba(125,211,252,.35)}
    .miniHelp{color:var(--muted2);font-size:12px;margin-top:8px;line-height:1.45}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;border-radius:12px;
      box-shadow:var(--shadow);
      display:none;
      max-width: min(740px, calc(100vw - 30px));
      font-size:13px;
      line-height:1.35;
    }
    .toast b{font-weight:900}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Adventure Fund</h1>
        <div class="subtitle">
          Accounts + Category Allocation Engine (sheet-backed). Transfers are intentional. Accurizer corrects reality drift.
        </div>
      </div>

      <div class="yearRow">
        <div class="pillRow" id="yearPills"></div>
        <div class="pillRow">
          <button class="btn primary" id="refreshBtn">Refresh Sheet</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="nav">
        <button class="navBtn active" data-view="dashboard">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Dashboard</div><div class="navHint">Fund • reserved • buffer</div></div></div>
        </button>
        <button class="navBtn" data-view="accounts">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Accounts</div><div class="navHint">Balances • transfers</div></div></div>
        </button>
        <button class="navBtn" data-view="categories">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Categories</div><div class="navHint">Budgets (editable)</div></div></div>
        </button>
        <button class="navBtn" data-view="trips">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Trips</div><div class="navHint">Rollups only</div></div></div>
        </button>
        <button class="navBtn" data-view="accurizer">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Accurizer</div><div class="navHint">Set actual balances</div></div></div>
        </button>

        <div style="height:10px"></div>
        <div class="miniHelp">
          <b>Rule:</b> Transfers do not change Total Fund. Accurizer can.
        </div>
      </div>

      <div class="main">
        <!-- DASHBOARD -->
        <div class="panel" data-panel="dashboard">
          <div class="grid5">
            <div class="card">
              <div class="kLabel">Total Fund</div>
              <div class="kVal" id="k_total">$0</div>
              <div class="kSub">Sum of included accounts (Actual_Balances)</div>
            </div>

            <div class="card">
              <div class="kLabel">Reserved</div>
              <div class="kVal" id="k_reserved">$0</div>
              <div class="kSub">Sum of category budgets (Category_Budgets)</div>
            </div>

            <div class="card">
              <div class="kLabel">Free Liquidity</div>
              <div class="kVal" id="k_free">$0</div>
              <div class="kSub">Total Fund − Reserved</div>
            </div>

            <div class="card">
              <div class="kLabel">Projected Year-End</div>
              <div class="kVal" id="k_yearEnd">$0</div>
              <div class="kSub" id="k_yearEnd_sub">Total + Remaining Income − Reserved</div>
            </div>

            <div class="card">
              <div class="kLabel">Goal Floor + Buffer</div>
              <div class="kVal" id="k_floor">$0</div>
              <div class="kSub" id="k_buffer">—</div>
              <div class="barWrap"><div class="bar" id="goalBar"></div></div>
            </div>
          </div>

          <div class="twoCol">
            <div class="card">
              <div class="kLabel">Remaining Income</div>
              <div class="miniHelp">Biweekly auto-deposit is deterministic by date. Gifts/incentive count if not received.</div>
              <div id="income_box"></div>
            </div>

            <div class="card">
              <div class="kLabel">Trip Rollups (planned only)</div>
              <div class="miniHelp">Trips are planning visibility. Budget impact is via Categories (Fuel/Lodging).</div>

              <div class="row">
                <div>
                  <div class="rowTitle">Planned Trips Total</div>
                  <div class="rowMeta">Sum Trip Total where Status=planned (Trips)</div>
                </div>
                <div class="rowRight"><span class="tag" id="t_total">$0</span></div>
              </div>

              <div class="row">
                <div>
                  <div class="rowTitle">Projected Fuel</div>
                  <div class="rowMeta">Sum Final Fuel Cost where Status=planned</div>
                </div>
                <div class="rowRight"><span class="tag" id="t_fuel">$0</span></div>
              </div>

              <div class="row">
                <div>
                  <div class="rowTitle">Projected Lodging</div>
                  <div class="rowMeta">Sum Lodging Cost where Status=planned</div>
                </div>
                <div class="rowRight"><span class="tag" id="t_lodging">$0</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ACCOUNTS -->
        <div class="panel" data-panel="accounts" style="display:none">
          <div class="card">
            <div class="kLabel">Accounts</div>
            <div class="miniHelp">Transfers write back immediately to Actual_Balances. Total Fund will not change.</div>
            <div id="acct_list"></div>

            <div style="height:12px"></div>

            <div class="kLabel">Transfer</div>
            <div class="fieldRow">
              <select id="x_from"></select>
              <select id="x_to"></select>
              <input id="x_amt" type="number" step="0.01" placeholder="Amount" style="width:160px" />
              <button class="btn primary" id="x_go">Transfer</button>
            </div>
            <div class="miniHelp">This is intentional planning. It is not “drift correction”.</div>
          </div>
        </div>

        <!-- CATEGORIES -->
        <div class="panel" data-panel="categories" style="display:none">
          <div class="card">
            <div class="kLabel">Category Budgets (Year: <span id="catYearLabel"></span>)</div>
            <div class="miniHelp">Editing a budget immediately changes projection (Reserved). Writes back immediately.</div>
            <div id="cat_list"></div>
          </div>
        </div>

        <!-- TRIPS -->
        <div class="panel" data-panel="trips" style="display:none">
          <div class="card">
            <div class="kLabel">Trips (Year: <span id="tripYearLabel"></span>)</div>
            <div class="miniHelp">Trips here are visibility + rollup. Budget impact is via Categories.</div>
            <div id="trip_list"></div>
          </div>
        </div>

        <!-- ACCURIZER -->
        <div class="panel" data-panel="accurizer" style="display:none">
          <div class="card">
            <div class="kLabel">Accurizer (Set Actual Balances)</div>
            <div class="miniHelp">
              Use this when reality drift happens (interest, unexpected cash, correction). Writes back immediately.
            </div>
            <div id="acc_list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   CONFIG
   ========================= */
const SHEET_BASE =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=";

const ACTUAL_BALANCES_CSV  = SHEET_BASE + "0&single=true&output=csv";
const INCOME_CSV           = SHEET_BASE + "1567617658&single=true&output=csv";
const CATEGORY_BUDGETS_CSV = SHEET_BASE + "1140620863&single=true&output=csv";
const TRIPS_CSV            = SHEET_BASE + "2037449837&single=true&output=csv";
const YEAR_SETTINGS_CSV    = SHEET_BASE + "1350021405&single=true&output=csv";

// WRITE ENDPOINT (Apps Script Web App)
const WRITEBACK_URL = "https://script.google.com/macros/s/OLD_URL/exec";

  

/* =========================
   STATE
   ========================= */
const LS_KEY = "af_live_v3";
const today = new Date();
const TODAY_ISO = isoDate(today);

const state = loadState() || {
  year: 2026,
  // sheet data
  accounts: [],
  income: [],
  budgets: [],
  trips: [],
  yearSettings: [],
  // health
  loadedAt: null,
  lastError: null
};

function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/* =========================
   UTIL
   ========================= */
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

function isoDate(d){
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function money(n){
  const v = Number(n||0);
  const sign = v < 0 ? "-" : "";
  return sign + "$" + Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function safeNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function toast(msg, kind=""){
  const t = $("#toast");
  t.style.display="block";
  t.innerHTML = (kind ? `<b>${escapeHtml(kind)}:</b> ` : "") + escapeHtml(msg);
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ t.style.display="none"; }, 3200);
}

/* =========================
   CSV (quoted safe)
   ========================= */
function parseCSV(text){
  const rows = [];
  let row = [], cur = "", inQ = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if(inQ){
      if(ch === '"' && next === '"'){ cur += '"'; i++; }
      else if(ch === '"'){ inQ = false; }
      else cur += ch;
    }else{
      if(ch === '"'){ inQ = true; }
      else if(ch === ','){ row.push(cur); cur=""; }
      else if(ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; }
      else if(ch === '\r'){ /* ignore */ }
      else cur += ch;
    }
  }
  row.push(cur); rows.push(row);
  while(rows.length && rows[rows.length-1].every(c => String(c||"").trim()==="")) rows.pop();
  return rows;
}
function headMap(head){
  const m = {};
  head.forEach((h,i)=> m[String(h||"").trim()] = i);
  return m;
}
async function fetchCSV(url){
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("Fetch failed: " + res.status);
  return res.text();
}

/* =========================
   WRITEBACK
   ========================= */
async function postWrite(payload){
  const res = await fetch(WRITEBACK_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  let data;
  try{ data = JSON.parse(text); } catch { data = { ok:false, error:text }; }
  if(!res.ok || !data.ok){
    throw new Error(data.error || ("Write failed: HTTP " + res.status));
  }
  return data;
}

/* =========================
   LOAD SHEET DATA
   ========================= */
async function loadSheetData(){
  state.lastError = null;
  const pulls = await Promise.allSettled([
    fetchCSV(ACTUAL_BALANCES_CSV),
    fetchCSV(INCOME_CSV),
    fetchCSV(CATEGORY_BUDGETS_CSV),
    fetchCSV(TRIPS_CSV),
    fetchCSV(YEAR_SETTINGS_CSV)
  ]);

  const get = (idx, label) => {
    const p = pulls[idx];
    if(p.status !== "fulfilled"){
      throw new Error(label + " failed: " + (p.reason?.message || "unknown error"));
    }
    return p.value;
  };

  // Actual_Balances: account_id, account_name, current_balance, include_in_projection
  {
    const rows = parseCSV(get(0,"Actual_Balances"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.accounts = rows
      .filter(r => String(r[hm.account_id]||"").trim())
      .map(r => ({
        account_id: String(r[hm.account_id]||"").trim(),
        account_name: String(r[hm.account_name]||"").trim(),
        current_balance: safeNum(r[hm.current_balance]),
        include_in_projection: String(r[hm.include_in_projection]||"TRUE").trim().toUpperCase() !== "FALSE"
      }));
  }

  // Income: income_id,income_type,description,amount,recurrence,start_date,year,received
  {
    const rows = parseCSV(get(1,"Income"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.income = rows
      .filter(r => String(r[hm.income_id]||"").trim())
      .map(r => ({
        income_id: String(r[hm.income_id]||"").trim(),
        income_type: String(r[hm.income_type]||"").trim(),
        description: String(r[hm.description]||"").trim(),
        amount: safeNum(r[hm.amount]),
        recurrence: String(r[hm.recurrence]||"").trim().toLowerCase(),
        start_date: String(r[hm.start_date]||"").trim(),
        year: safeNum(r[hm.year]),
        received: String(r[hm.received]||"FALSE").trim().toUpperCase() === "TRUE"
      }));
  }

  // Category_Budgets: category_id,category_name,annual_budget,year
  {
    const rows = parseCSV(get(2,"Category_Budgets"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.budgets = rows
      .filter(r => String(r[hm.category_id]||"").trim())
      .map(r => ({
        category_id: String(r[hm.category_id]||"").trim(),
        category_name: String(r[hm.category_name]||"").trim(),
        annual_budget: safeNum(r[hm.annual_budget]),
        year: safeNum(r[hm.year])
      }));
  }

  // Trips: (supports your current layout) include year + status if present; default planned
  {
    const rows = parseCSV(get(3,"Trips"));
    const head = (rows.shift() || []).map(h=>String(h||"").trim());
    const hm = headMap(head);

    const idx = (name, fallback) => (hm[name]!==undefined ? hm[name] : fallback);

    state.trips = rows
      .filter(r => String(r[idx("Trip Name",0)]||"").trim())
      .map(r => ({
        name: String(r[idx("Trip Name",0)]||"").trim(),
        plannedMiles: safeNum(r[idx("Planned Miles",1)]),
        vehicle: String(r[idx("Vehicle",2)]||"").trim(),
        finalFuel: safeNum(r[idx("Final Fuel Cost",8)]),
        lodging: safeNum(r[idx("Lodging Cost",9)]),
        total: safeNum(r[idx("Trip Total",10)]),
        year: safeNum(r[idx("Year",11)]),
        status: String(r[idx("Status",12)] || "planned").trim().toLowerCase()
      }));
  }

  // Year_Settings: year,minimum_balance,auto_increment
  {
    const rows = parseCSV(get(4,"Year_Settings"));
    const head = rows.shift() || [];
    const hm = headMap(head);
    state.yearSettings = rows
      .filter(r => safeNum(r[hm.year]))
      .map(r => ({
        year: safeNum(r[hm.year]),
        minimum_balance: safeNum(r[hm.minimum_balance]),
        auto_increment: safeNum(r[hm.auto_increment])
      }))
      .sort((a,b)=>a.year-b.year);

    if(state.yearSettings.length){
      const years = state.yearSettings.map(x=>x.year);
      if(!years.includes(state.year)) state.year = years[0];
    }
  }

  state.loadedAt = TODAY_ISO;
  saveState();
}

/* =========================
   ENGINE
   ========================= */
function sumIncludedAccounts(){
  return state.accounts.filter(a=>a.include_in_projection).reduce((s,a)=>s+safeNum(a.current_balance),0);
}
function reservedBudgets(year){
  return state.budgets.filter(b=>b.year===year).reduce((s,b)=>s+safeNum(b.annual_budget),0);
}
function goalFloor(year){
  const y = state.yearSettings.find(x=>x.year===year);
  return y ? safeNum(y.minimum_balance) : 0;
}

function incomeRemaining(year){
  // Biweekly: deterministic occurrences within year that are >= today if year is current; all occurrences if future; none if past.
  // One-time: counts if year matches and received=false.
  const yearNow = (new Date()).getFullYear();
  const jan1 = new Date(`${year}-01-01T00:00:00`);
  const dec31 = new Date(`${year}-12-31T00:00:00`);
  const todayD = new Date(TODAY_ISO + "T00:00:00");

  let total = 0;
  const lines = [];

  for(const inc of state.income){
    if(inc.year !== year) continue;

    if(inc.recurrence === "biweekly"){
      const start = new Date(String(inc.start_date||"") + "T00:00:00");
      if(isNaN(start)) continue;

      // align to first occurrence in-year
      let d = new Date(start);
      while(d < jan1) d.setDate(d.getDate()+14);
      while(d > dec31) d.setDate(d.getDate()-14);

      let count = 0;
      while(d.getFullYear() === year){
        const isPastYear = year < yearNow;
        const include =
          isPastYear ? false :
          (year > yearNow) ? true :
          (d >= todayD);

        if(include) count++;
        d.setDate(d.getDate()+14);
      }

      const add = count * safeNum(inc.amount);
      total += add;
      lines.push({ label: inc.description || "Biweekly deposit", amount: add, meta: `${count} remaining` });
    } else {
      if(inc.received) continue;
      const add = safeNum(inc.amount);
      total += add;
      lines.push({ label: inc.description || inc.income_type, amount: add, meta: "pending" });
    }
  }

  // show top items; total is what matters
  lines.sort((a,b)=>b.amount-a.amount);
  return { total, lines };
}

function tripRollup(year){
  const planned = state.trips.filter(t=>t.year===year && (t.status||"planned")==="planned");
  return {
    total: planned.reduce((s,t)=>s+safeNum(t.total),0),
    fuel: planned.reduce((s,t)=>s+safeNum(t.finalFuel),0),
    lodging: planned.reduce((s,t)=>s+safeNum(t.lodging),0)
  };
}

function computeDashboard(year){
  const fund = sumIncludedAccounts();
  const reserved = reservedBudgets(year);
  const income = incomeRemaining(year).total;
  const yearEnd = fund + income - reserved;
  const floor = goalFloor(year);
  const buffer = yearEnd - floor;
  const free = fund - reserved;
  return { fund, reserved, free, income, yearEnd, floor, buffer };
}

/* =========================
   RENDER
   ========================= */
function setView(view){
  $$(".navBtn").forEach(b=> b.classList.toggle("active", b.dataset.view===view));
  $$("[data-panel]").forEach(p=> p.style.display = (p.dataset.panel===view) ? "block" : "none");
}

function renderYears(){
  const host = $("#yearPills");
  host.innerHTML = "";
  const years = state.yearSettings.length ? state.yearSettings.map(x=>x.year) : [2026,2027,2028];

  for(const y of years.slice(0,5)){
    const b = document.createElement("button");
    b.className = "pill" + (state.year===y ? " active" : "");
    b.textContent = y;
    b.onclick = ()=>{ state.year=y; saveState(); renderAll(); };
    host.appendChild(b);
  }
}

function renderDashboard(){
  const y = state.year;
  const d = computeDashboard(y);
  const inc = incomeRemaining(y);
  const tr = tripRollup(y);

  $("#k_total").textContent = money(d.fund);
  $("#k_reserved").textContent = money(d.reserved);
  $("#k_free").textContent = money(d.free);
  $("#k_yearEnd").textContent = money(d.yearEnd);
  $("#k_floor").textContent = money(d.floor);

  const buf = $("#k_buffer");
  if(d.floor<=0){
    buf.innerHTML = `<span class="warn">Set Year_Settings minimum_balance for ${y}</span>`;
  } else if(d.buffer>=0){
    buf.innerHTML = `<span class="good">Above floor by ${money(d.buffer)}</span>`;
  } else {
    buf.innerHTML = `<span class="bad">Below floor by ${money(Math.abs(d.buffer))}</span>`;
  }

  const pct = d.floor>0 ? Math.max(0, Math.min(100, (d.yearEnd/d.floor)*100)) : 0;
  $("#goalBar").style.width = pct + "%";
  $("#goalBar").style.background = (d.floor>0 && d.buffer<0) ? "var(--bad)" : "var(--good)";

  // income box
  const ib = $("#income_box");
  ib.innerHTML = "";
  ib.appendChild(rowKV("Remaining Income Total", money(inc.total), "Total expected income still to come in this year"));

  if(!inc.lines.length){
    ib.innerHTML += `<div class="miniHelp">No remaining income entries found for ${y}.</div>`;
  } else {
    for(const l of inc.lines.slice(0,10)){
      ib.appendChild(rowKV(l.label, money(l.amount), l.meta));
    }
    if(inc.lines.length>10){
      ib.innerHTML += `<div class="miniHelp">+ ${inc.lines.length-10} more…</div>`;
    }
  }

  // trip rollups
  $("#t_total").textContent = money(tr.total);
  $("#t_fuel").textContent = money(tr.fuel);
  $("#t_lodging").textContent = money(tr.lodging);
}

function rowKV(title, val, meta){
  const row = document.createElement("div");
  row.className = "row";
  row.innerHTML = `
    <div>
      <div class="rowTitle">${escapeHtml(title)}</div>
      <div class="rowMeta">${escapeHtml(meta||"")}</div>
    </div>
    <div class="rowRight"><span class="tag">${escapeHtml(val)}</span></div>
  `;
  return row;
}

function renderAccounts(){
  const host = $("#acct_list");
  host.innerHTML = "";

  const from = $("#x_from");
  const to = $("#x_to");
  from.innerHTML = ""; to.innerHTML = "";

  for(const a of state.accounts){
    const opt1 = document.createElement("option");
    opt1.value = a.account_id;
    opt1.textContent = `${a.account_name}`;
    const opt2 = opt1.cloneNode(true);
    from.appendChild(opt1);
    to.appendChild(opt2);
  }
  if(state.accounts.length>=2) to.selectedIndex = 1;

  for(const a of state.accounts){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(a.account_name)} <span class="tag" style="margin-left:6px">${escapeHtml(a.account_id)}</span></div>
        <div class="rowMeta">Included in projection: <b>${a.include_in_projection ? "TRUE" : "FALSE"}</b></div>
      </div>
      <div class="rowRight">
        <span class="tag">${money(a.current_balance)}</span>
      </div>
    `;
    host.appendChild(row);
  }
}

function renderCategories(){
  const y = state.year;
  $("#catYearLabel").textContent = y;

  const host = $("#cat_list");
  host.innerHTML = "";

  const list = state.budgets.filter(b=>b.year===y);
  if(!list.length){
    host.innerHTML = `<div class="miniHelp">No category budgets found for ${y}.</div>`;
    return;
  }

  for(const b of list){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div style="min-width:0;flex:1">
        <div class="rowTitle">${escapeHtml(b.category_name)} <span class="tag" style="margin-left:6px">${escapeHtml(b.category_id)}</span></div>
        <div class="rowMeta">Budget reserved against year projection.</div>
      </div>
      <div class="rowRight">
        <input data-bid="${escapeHtml(b.category_id)}" type="number" step="1" style="width:160px" value="${b.annual_budget}">
        <button class="btn primary" data-save="${escapeHtml(b.category_id)}">Save</button>
      </div>
    `;
    host.appendChild(row);
  }

  host.querySelectorAll("button[data-save]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-save");
      const inp = host.querySelector(`input[data-bid="${CSS.escape(id)}"]`);
      const val = safeNum(inp?.value);
      if(val < 0) return;

      btn.textContent = "Saving…";
      btn.disabled = true;

      try{
        await postWrite({
          action: "updateCategoryBudgets",
          updates: [{ category_id: id, year: state.year, annual_budget: val }]
        });
        toast("Category budget saved.", "Saved");
        await loadSheetData();
        renderAll();
      }catch(e){
        toast(e.message || "Save failed", "Error");
      } finally {
        btn.textContent = "Save";
        btn.disabled = false;
      }
    };
  });
}

function renderTrips(){
  const y = state.year;
  $("#tripYearLabel").textContent = y;

  const host = $("#trip_list");
  host.innerHTML = "";

  const list = state.trips.filter(t=>t.year===y);
  if(!list.length){
    host.innerHTML = `<div class="miniHelp">No trips found for ${y}.</div>`;
    return;
  }

  for(const t of list){
    const planned = (t.status||"planned")==="planned";
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(t.name)} <span class="tag" style="margin-left:6px">${escapeHtml(t.status||"planned")}</span></div>
        <div class="rowMeta">${escapeHtml(t.vehicle)} • ${t.plannedMiles} mi • Fuel ${money(t.finalFuel)} • Lodging ${money(t.lodging)}</div>
      </div>
      <div class="rowRight">
        <span class="tag">${money(t.total)}</span>
        <span class="tag" style="border-color:${planned?'rgba(63,210,140,.35)':'rgba(255,93,93,.35)'};color:${planned?'var(--good)':'var(--muted)'}">
          ${planned ? "Counts in rollup" : "Complete (ignored)"}
        </span>
      </div>
    `;
    host.appendChild(row);
  }
}

function renderAccurizer(){
  const host = $("#acc_list");
  host.innerHTML = "";

  for(const a of state.accounts){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(a.account_name)} <span class="tag" style="margin-left:6px">${escapeHtml(a.account_id)}</span></div>
        <div class="rowMeta">Sheet balance: ${money(a.current_balance)}</div>
      </div>
      <div class="rowRight">
        <input data-acc="${escapeHtml(a.account_id)}" type="number" step="0.01" style="width:170px" placeholder="Actual now">
        <button class="btn primary" data-set="${escapeHtml(a.account_id)}">Set Actual</button>
      </div>
    `;
    host.appendChild(row);
  }

  host.querySelectorAll("button[data-set]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-set");
      const inp = host.querySelector(`input[data-acc="${CSS.escape(id)}"]`);
      const valRaw = inp?.value;
      if(valRaw===undefined || valRaw===null || String(valRaw).trim()==="") return;
      const actual = safeNum(valRaw);

      btn.textContent = "Saving…";
      btn.disabled = true;

      try{
        await postWrite({
          action: "updateBalances",
          updates: [{ account_id: id, current_balance: actual }]
        });
        toast("Balance updated.", "Saved");
        await loadSheetData();
        renderAll();
      }catch(e){
        toast(e.message || "Save failed", "Error");
      } finally {
        btn.textContent = "Set Actual";
        btn.disabled = false;
      }
    };
  });
}

function renderAll(){
  renderYears();
  renderDashboard();
  renderAccounts();
  renderCategories();
  renderTrips();
  renderAccurizer();
}

/* =========================
   ACTIONS
   ========================= */
async function doTransfer(){
  const fromId = $("#x_from").value;
  const toId = $("#x_to").value;
  const amt = safeNum($("#x_amt").value);

  if(!fromId || !toId || fromId===toId || !amt || amt<=0){
    toast("Select two different accounts and enter an amount.", "Transfer");
    return;
  }

  const from = state.accounts.find(a=>a.account_id===fromId);
  const to = state.accounts.find(a=>a.account_id===toId);
  if(!from || !to){
    toast("Account lookup failed. Refresh sheet.", "Error");
    return;
  }

  const newFrom = safeNum(from.current_balance) - amt;
  const newTo = safeNum(to.current_balance) + amt;

  if(newFrom < -0.0001){
    toast("Insufficient funds in the FROM account (would go negative).", "Blocked");
    return;
  }

  const btn = $("#x_go");
  btn.textContent = "Transferring…";
  btn.disabled = true;

  try{
    await postWrite({
      action: "updateBalances",
      updates: [
        { account_id: fromId, current_balance: newFrom },
        { account_id: toId, current_balance: newTo }
      ]
    });
    $("#x_amt").value = "";
    toast("Transfer complete.", "Transfer");
    await loadSheetData();
    renderAll();
  }catch(e){
    toast(e.message || "Transfer failed", "Error");
  } finally {
    btn.textContent = "Transfer";
    btn.disabled = false;
  }
}

/* =========================
   INIT + UI WIRE
   ========================= */
function wireUI(){
  $$(".navBtn").forEach(b=> b.onclick = ()=> setView(b.dataset.view));

  $("#refreshBtn").onclick = async ()=>{
    $("#refreshBtn").textContent = "Refreshing…";
    try{
      await loadSheetData();
      renderAll();
      toast("Sheet refreshed.", "OK");
    }catch(e){
      toast(e.message || "Refresh failed", "Error");
    } finally {
      $("#refreshBtn").textContent = "Refresh Sheet";
    }
  };

  $("#x_go").onclick = doTransfer;
}

// Boot
(async function init(){
  wireUI();
  setView("dashboard");
  try{
    await loadSheetData();
  }catch(e){
    state.lastError = e.message || String(e);
    toast(state.lastError, "Error");
  }
  saveState();
  renderAll();
})();
</script>
</body>
</html>
