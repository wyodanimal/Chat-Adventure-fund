<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Adventure Fund Control Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
body{
  margin:0;
  font-family:Inter, sans-serif;
  background:#0f1419;
  color:#e6edf3;
}
.wrap{max-width:1100px;margin:0 auto;padding:30px;}
h1{margin:0 0 20px 0;}
.panel{
  background:#161b22;
  border:1px solid #2a2f36;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
}
.big{
  font-size:34px;
  font-weight:800;
}
.good{color:#3fb950;}
.bad{color:#f85149;}
button{
  background:#21262d;
  border:1px solid #30363d;
  color:#e6edf3;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
}
button.active{
  background:#238636;
}
.trip{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid #2a2f36;
}
input{
  background:#0d1117;
  border:1px solid #30363d;
  color:white;
  padding:6px;
  border-radius:6px;
  width:120px;
}
.sim{
  display:flex;
  gap:10px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="wrap">

<h1>Adventure Fund – Control Panel</h1>

<div class="panel">
  <div>Year End Projection</div>
  <div class="big" id="projection">$0</div>
  <div id="goalLine"></div>
</div>

<div class="panel">
  <div style="font-weight:700;margin-bottom:10px;">Trip Commitments (toggle on/off)</div>
  <div id="tripList"></div>
</div>

<div class="panel">
  <div style="font-weight:700;">Quick Simulation</div>
  <div class="sim">
    <input id="simAmount" placeholder="$ Amount">
    <button onclick="addSimulation()">Add Temp Cost</button>
    <button onclick="clearSimulation()">Clear</button>
  </div>
</div>

</div>

<script>
const TXN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=1140620863&single=true&output=csv";
const TRIPS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=2037449837&single=true&output=csv";
const GOALS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=948171494&single=true&output=csv";

let state={
  year:new Date().getFullYear(),
  balance:0,
  goal:0,
  trips:[],
  simulation:0
};

function money(n){return "$"+Number(n).toLocaleString();}

async function load(){
  const [t1,t2,t3]=await Promise.all([
    fetch(TXN).then(r=>r.text()),
    fetch(TRIPS).then(r=>r.text()),
    fetch(GOALS).then(r=>r.text())
  ]);

  // Transactions
  let rows=t1.trim().split("\n");
  let head=rows.shift().split(",");
  let dateIndex=head.indexOf("date");
  let amtIndex=head.indexOf("amount");
  rows.forEach(r=>{
    let cols=r.split(",");
    let d=new Date(cols[dateIndex]);
    if(d.getFullYear()===state.year){
      state.balance+=Number(cols[amtIndex]);
    }
  });

  // Trips
  let tripRows=t2.trim().split("\n");
  tripRows.shift();
  tripRows.forEach(r=>{
    let cols=r.split(",");
    if(cols[0]){
      state.trips.push({
        name:cols[0],
        cost:Number(cols[13]||0),
        active:true
      });
    }
  });

  // Goals
  let goalRows=t3.trim().split("\n");
  goalRows.shift();
  goalRows.forEach(r=>{
    let cols=r.split(",");
    if(Number(cols[0])===state.year){
      state.goal=Number(cols[1]);
    }
  });

  render();
}

function render(){
  let committed=state.trips.filter(t=>t.active).reduce((s,t)=>s+t.cost,0);
  let projected=state.balance-committed-state.simulation;

  document.getElementById("projection").textContent=money(projected);

  let delta=projected-state.goal;
  let goalLine=document.getElementById("goalLine");
  if(delta>=0){
    goalLine.innerHTML="<span class='good'>Above floor by "+money(delta)+"</span>";
  }else{
    goalLine.innerHTML="<span class='bad'>Below floor by "+money(Math.abs(delta))+"</span>";
  }

  let list=document.getElementById("tripList");
  list.innerHTML="";
  state.trips.forEach((t,i)=>{
    list.innerHTML+=`
      <div class="trip">
        <div>${t.name} – ${money(t.cost)}</div>
        <button class="${t.active?'active':''}" onclick="toggleTrip(${i})">
          ${t.active?'Included':'Excluded'}
        </button>
      </div>
    `;
  });
}

function toggleTrip(i){
  state.trips[i].active=!state.trips[i].active;
  render();
}

function addSimulation(){
  let val=Number(document.getElementById("simAmount").value);
  if(!isNaN(val)){
    state.simulation+=val;
    render();
  }
}

function clearSimulation(){
  state.simulation=0;
  document.getElementById("simAmount").value="";
  render();
}

load();
</script>
</body>
</html>
