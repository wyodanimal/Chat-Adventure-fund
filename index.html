<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adventure Fund — Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1117;
      --panel:#101823;
      --panel2:#0f1620;
      --card:#121c2a;
      --line:rgba(255,255,255,.08);
      --text:#e8eef7;
      --muted:#9fb0c9;
      --muted2:#7f8aa3;

      --good:#3fd28c;
      --bad:#ff5d5d;
      --warn:#ffcc66;
      --accent:#7dd3fc;
      --accent2:#9ae6b4;

      --shadow: 0 20px 60px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(900px 700px at 80% 10%, rgba(154,230,180,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:26px 22px 42px;}
    .top{
      display:flex;align-items:flex-end;justify-content:space-between;gap:14px;flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{
      display:flex;flex-direction:column;gap:6px;
    }
    .title h1{margin:0;font-weight:800;letter-spacing:-.02em;font-size:28px}
    .subtitle{color:var(--muted);font-size:13px}

    .yearRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pillRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .pill:hover{transform:translateY(-1px);background:rgba(255,255,255,.05)}
    .pill.active{
      background:linear-gradient(180deg, rgba(125,211,252,.18), rgba(154,230,180,.12));
      border-color:rgba(125,211,252,.35);
    }

    .layout{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap:14px;
      margin-top:14px;
    }
    .nav{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:12px;
      box-shadow:var(--shadow);
      position:sticky; top:14px;
      height: fit-content;
    }
    .navBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      transition:.15s ease;
      margin-bottom:8px;
    }
    .navBtn:hover{background:rgba(255,255,255,.04)}
    .navBtn.active{
      background:rgba(125,211,252,.10);
      border-color:rgba(125,211,252,.25);
    }
    .navLeft{display:flex;align-items:center;gap:10px}
    .dot{
      width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .navBtn.active .dot{background:rgba(125,211,252,.7); box-shadow:0 0 0 3px rgba(125,211,252,.15)}
    .navLabel{font-weight:700;font-size:13px}
    .navHint{color:var(--muted2);font-size:12px}

    .main{min-width:0;}
    .panel{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      .nav{position:relative;top:auto}
      .grid3{grid-template-columns: 1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:14px;
      min-height:104px;
    }
    .kLabel{color:var(--muted);font-size:12px;letter-spacing:.02em;text-transform:uppercase}
    .kVal{font-size:30px;font-weight:800;margin-top:6px;letter-spacing:-.02em}
    .kSub{margin-top:6px;color:var(--muted2);font-size:12px}
    .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    .barWrap{
      margin-top:10px;
      height:12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
    }
    .bar{
      height:100%;
      width:0%;
      background:var(--good);
      transition:width .25s ease;
    }

    .row{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row:last-child{border-bottom:none}
    .rowTitle{font-weight:700;font-size:14px}
    .rowMeta{color:var(--muted2);font-size:12px;margin-top:2px}
    .rowRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.06)}
    .btn.primary{
      border-color:rgba(125,211,252,.35);
      background:rgba(125,211,252,.12);
    }
    .btn.good{
      border-color:rgba(63,210,140,.35);
      background:rgba(63,210,140,.10);
    }
    .btn.bad{
      border-color:rgba(255,93,93,.35);
      background:rgba(255,93,93,.10);
    }
    .tag{
      font-family:var(--mono);
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.02);
    }

    .twoCol{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:980px){.twoCol{grid-template-columns:1fr}}

    .fieldRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input{
      background:rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 10px;
      border-radius:10px;
      font-size:13px;
      outline:none;
      min-width: 140px;
    }
    input:focus{border-color:rgba(125,211,252,.35)}
    .miniHelp{color:var(--muted2);font-size:12px;margin-top:8px;line-height:1.45}

    .monoBox{
      font-family:var(--mono);
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.30);
      white-space:pre-wrap;
      word-break:break-word;
      max-height: 240px;
      overflow:auto;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>Adventure Fund — Studio</h1>
        <div class="subtitle">Sheet-backed planner + scenario console (read + simulate now, commit pack for paste-in)</div>
      </div>

      <div class="yearRow">
        <div class="pillRow" id="yearPills"></div>
        <div class="pillRow">
          <span class="tag">Goal Floor</span>
          <input id="goalInput" type="number" step="1" style="width:140px" />
          <button class="btn primary" id="refreshBtn">Refresh Sheet</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="nav">
        <button class="navBtn active" data-view="dashboard">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Dashboard</div><div class="navHint">Runway + buffer</div></div></div>
        </button>
        <button class="navBtn" data-view="income">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Income</div><div class="navHint">Auto pay + extras</div></div></div>
        </button>
        <button class="navBtn" data-view="expenses">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Expenses</div><div class="navHint">Budgets + log</div></div></div>
        </button>
        <button class="navBtn" data-view="trips">
          <div class="navLeft"><span class="dot"></span><div><div class="navLabel">Trips</div><div class="navHint">Toggle + cost</div></div></div>
        </button>
        <div style="height:10px"></div>
        <div class="miniHelp">
          <b>Commit Pack</b> shows copy/paste rows (CSV) you can paste into your Sheet now.
          Write-back API can be wired later without changing the UI.
        </div>
      </div>

      <div class="main">
        <!-- DASHBOARD -->
        <div class="panel" data-panel="dashboard">
          <div class="grid3">
            <div class="card">
              <div class="kLabel">Fund Balance</div>
              <div class="kVal" id="k_balance">$0</div>
              <div class="kSub" id="k_balance_sub">from sheet transactions (year filter)</div>
            </div>
            <div class="card">
              <div class="kLabel">Committed</div>
              <div class="kVal" id="k_committed">$0</div>
              <div class="kSub">included trips + logged expenses</div>
            </div>
            <div class="card">
              <div class="kLabel">Projected Year-End</div>
              <div class="kVal" id="k_projected">$0</div>
              <div class="kSub" id="k_delta">—</div>
              <div class="barWrap"><div class="bar" id="goalBar"></div></div>
            </div>
          </div>

          <div class="twoCol">
            <div class="card">
              <div class="kLabel">Scenario Controls</div>
              <div class="fieldRow">
                <input id="sim_note" placeholder="Note (optional)" />
                <input id="sim_amount" type="number" step="1" placeholder="Amount (e.g., 650)" />
                <button class="btn bad" id="sim_add_cost">Add Cost</button>
                <button class="btn good" id="sim_add_income">Add Income</button>
                <button class="btn" id="sim_clear">Clear Scenarios</button>
              </div>
              <div class="miniHelp">
                Use this like a “what-if slider.” Add costs/income and watch the dashboard update instantly.
                These do NOT touch the sheet until you paste a Commit Pack row.
              </div>
              <div class="row">
                <div>
                  <div class="rowTitle">Scenario Net</div>
                  <div class="rowMeta">costs and income added in this UI session</div>
                </div>
                <div class="rowRight">
                  <span class="tag" id="sim_net">$0</span>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="kLabel">Commit Pack (copy/paste)</div>
              <div class="miniHelp">
                These are rows you can paste into your sheet as transactions (or a “staging” tab) right now.
                Later we replace this with real write-back without changing the UX.
              </div>
              <div class="monoBox" id="commit_pack">(no staged commits yet)</div>
            </div>
          </div>
        </div>

        <!-- INCOME -->
        <div class="panel" data-panel="income" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <div class="kLabel">Biweekly Pay Engine</div>
            <div class="fieldRow">
              <span class="tag">Pay amount</span>
              <input id="pay_amount" type="number" step="1" style="width:140px" />
              <span class="tag">First payday</span>
              <input id="pay_start" type="date" style="width:170px" />
              <button class="btn primary" id="pay_generate">Generate Paychecks</button>
              <button class="btn" id="pay_clear">Clear Paychecks</button>
            </div>
            <div class="miniHelp">
              Generates the full year of biweekly pay blocks. Click a block to mark “Received” (scenario),
              and it updates Year-End immediately.
            </div>
          </div>

          <div class="card">
            <div class="kLabel">Paychecks</div>
            <div id="pay_grid"></div>
          </div>

          <div style="height:12px"></div>

          <div class="card">
            <div class="kLabel">Extra Income</div>
            <div id="extra_income"></div>
            <div class="fieldRow">
              <input id="extra_desc" placeholder="Description" />
              <input id="extra_amt" type="number" step="1" placeholder="Amount" />
              <input id="extra_date" type="date" style="width:170px" />
              <button class="btn good" id="extra_add">Add Extra Income</button>
            </div>
          </div>
        </div>

        <!-- EXPENSES -->
        <div class="panel" data-panel="expenses" style="display:none">
          <div class="card">
            <div class="kLabel">Expense Categories (local but persistent)</div>
            <div class="miniHelp">
              This does NOT overwrite your sheet structure. It’s a working UI layer.
              Later we’ll map these to your Transactions tab (category field) via write-back.
            </div>
            <div id="cat_list"></div>

            <div class="fieldRow">
              <input id="cat_name" placeholder="Category (e.g., Bikepacking)" />
              <input id="cat_budget" type="number" step="1" placeholder="Budget" />
              <button class="btn primary" id="cat_add">Add Category</button>
            </div>
          </div>
        </div>

        <!-- TRIPS -->
        <div class="panel" data-panel="trips" style="display:none">
          <div class="card">
            <div class="kLabel">Trips (from Sheet Trips tab)</div>
            <div class="miniHelp">
              Toggle included/excluded to run scenarios.
              Edit cost here as a scenario override (does not touch sheet until you commit).
            </div>
            <div id="trip_list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG — YOUR CSV ENDPOINTS
   ========================= */
const TRIPS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=2037449837&single=true&output=csv";
const TRANSACTIONS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=1140620863&single=true&output=csv";
const GOALS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrEPrTSDI3CCwRpEKRifmZm4EIRxoq6n0meTIifGm2IApAWc4dsfZo-9QlLgIv_hp5TrcYBSwqflsh/pub?gid=948171494&single=true&output=csv";

/* =========================
   STATE
   ========================= */
const now = new Date();
const BASE_YEAR = now.getFullYear();

const LS_KEY = "af_studio_v1";
const state = loadState() || {
  year: BASE_YEAR,
  goalsByYear: {},

  // sheet data
  trips: [],
  txns: [],
  goalsSheet: {},

  // UI model (persistent)
  paycheck: { amount: 250, startDate: isoDate(new Date(BASE_YEAR, 1, 12)), blocks: [] }, // default Feb 12 current-year
  extraIncome: [], // {desc, amt, dateISO, received:true}
  categories: [],  // {name, budget, spent}
  tripOverrides: {}, // tripName => overrideCost
  tripIncluded: {},  // tripName => boolean

  // scenario delta
  scenario: { items: [] }, // {type:'cost'|'income', amt, note, id}

  // staged commit pack rows
  commits: [] // strings (csv lines)
};

function loadState(){
  try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; }
}
function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

function isoDate(d){
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}
function money(n){
  const v = Number(n||0);
  const sign = v < 0 ? "-" : "";
  return sign + "$" + Math.abs(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

/* =========================
   CSV helpers
   ========================= */
function parseCSV(text){
  // basic CSV (no quoted commas). Works for your current simple exports.
  const lines = text.trim().split(/\r?\n/);
  return lines.map(l => l.split(","));
}
async function fetchCSV(url){
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("Fetch failed: " + res.status);
  return res.text();
}

/* =========================
   Sheet loaders
   ========================= */
async function loadSheetData(){
  const [tTrips, tTxns, tGoals] = await Promise.all([
    fetchCSV(TRIPS_CSV),
    fetchCSV(TRANSACTIONS_CSV),
    fetchCSV(GOALS_CSV)
  ]);

  // Trips
  {
    const rows = parseCSV(tTrips);
    const head = rows.shift().map(h=>h.trim());
    const nameIdx = head.indexOf("name") >= 0 ? head.indexOf("name") : 0;
    // your Trip total column was at index 13 in prior builds
    const totalIdx = head.indexOf("total") >= 0 ? head.indexOf("total") : 13;

    state.trips = rows
      .filter(r => (r[nameIdx]||"").trim().length)
      .map(r => ({
        name: (r[nameIdx]||"").trim(),
        total: Number(r[totalIdx]||0)
      }));

    // init included map (default true)
    for(const tr of state.trips){
      if(state.tripIncluded[tr.name] === undefined) state.tripIncluded[tr.name] = true;
    }
  }

  // Transactions (sum amount by selected year)
  {
    const rows = parseCSV(tTxns);
    const head = rows.shift().map(h=>h.trim());
    const dateIdx = head.indexOf("date");
    const amtIdx = head.indexOf("amount");
    state.txns = rows
      .map(r => ({
        date: r[dateIdx],
        year: safeYear(r[dateIdx]),
        amount: Number(r[amtIdx]||0)
      }))
      .filter(x => Number.isFinite(x.amount));
  }

  // Goals
  {
    const rows = parseCSV(tGoals);
    rows.shift(); // header
    state.goalsSheet = {};
    for(const r of rows){
      const y = Number(r[0]||0);
      const g = Number(r[1]||0);
      if(y) state.goalsSheet[y] = g;
    }
    // merge into goalsByYear unless user already set something
    for(const [yStr,g] of Object.entries(state.goalsSheet)){
      const y = Number(yStr);
      if(state.goalsByYear[y] === undefined || state.goalsByYear[y] === null || state.goalsByYear[y] === 0){
        state.goalsByYear[y] = g;
      }
    }
  }

  // ensure current year goal exists
  if(!state.goalsByYear[state.year]){
    state.goalsByYear[state.year] = state.goalsSheet[state.year] || 9500;
  }

  saveState();
}
function safeYear(dateStr){
  const d = new Date(dateStr);
  if(!isNaN(d)) return d.getFullYear();
  // try YYYY-MM-DD substring
  const m = String(dateStr||"").match(/(\d{4})-/);
  return m ? Number(m[1]) : null;
}

/* =========================
   Computation Engine
   ========================= */
function yearBalanceFromSheet(year){
  return state.txns.filter(t=>t.year===year).reduce((s,t)=>s+t.amount,0);
}
function includedTripsTotal(){
  let sum = 0;
  for(const tr of state.trips){
    if(state.tripIncluded[tr.name]){
      const override = state.tripOverrides[tr.name];
      sum += Number.isFinite(Number(override)) && override !== "" && override !== null ? Number(override) : tr.total;
    }
  }
  return sum;
}
function expensesSpentTotal(){
  return state.categories.reduce((s,c)=>s + Number(c.spent||0), 0);
}
function incomeReceivedTotal(){
  // pay blocks received + extra income received
  const pay = state.paycheck.blocks.filter(b=>b.received).reduce((s,b)=>s+Number(b.amount||0),0);
  const extra = state.extraIncome.filter(x=>x.received).reduce((s,x)=>s+Number(x.amt||0),0);
  return pay + extra;
}
function scenarioNet(){
  // income positive, cost negative
  return state.scenario.items.reduce((s,it)=> s + (it.type==="income" ? Number(it.amt||0) : -Number(it.amt||0)), 0);
}
function projectedYearEnd(){
  const base = yearBalanceFromSheet(state.year);
  const committed = includedTripsTotal() + expensesSpentTotal();
  const proj = base + incomeReceivedTotal() - committed + scenarioNet();
  return { base, committed, proj };
}

/* =========================
   UI bindings
   ========================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function setView(view){
  $$(".navBtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.view===view);
  });
  $$("[data-panel]").forEach(p=>{
    p.style.display = (p.dataset.panel===view) ? "block" : "none";
  });
}

function renderYears(){
  const years = [BASE_YEAR, BASE_YEAR+1, BASE_YEAR+2];
  const host = $("#yearPills");
  host.innerHTML = "";
  for(const y of years){
    const b = document.createElement("button");
    b.className = "pill" + (state.year===y ? " active" : "");
    b.textContent = y;
    b.onclick = () => { state.year = y; if(!state.goalsByYear[y]) state.goalsByYear[y]=state.goalsSheet[y]||0; saveState(); renderAll(); };
    host.appendChild(b);
  }
}

function renderGoal(){
  const g = state.goalsByYear[state.year] ?? 0;
  $("#goalInput").value = g;
}

function renderDashboard(){
  const { base, committed, proj } = projectedYearEnd();
  const goal = Number(state.goalsByYear[state.year]||0);
  const delta = proj - goal;

  $("#k_balance").textContent = money(base);
  $("#k_committed").textContent = money(committed);
  $("#k_projected").textContent = money(proj);

  const deltaEl = $("#k_delta");
  if(goal<=0){
    deltaEl.innerHTML = `<span class="warn">Set a goal floor to track buffer</span>`;
  } else if(delta>=0){
    deltaEl.innerHTML = `<span class="good">Above floor by ${money(delta)}</span>`;
  } else {
    deltaEl.innerHTML = `<span class="bad">Below floor by ${money(Math.abs(delta))}</span>`;
  }

  // bar: proj/goal capped 0..100
  const pct = goal>0 ? Math.max(0, Math.min(100, (proj/goal)*100)) : 0;
  const bar = $("#goalBar");
  bar.style.width = pct + "%";
  bar.style.background = (goal>0 && delta<0) ? "var(--bad)" : "var(--good)";

  $("#sim_net").textContent = money(scenarioNet());
  renderCommitPack();
}

function renderCommitPack(){
  const box = $("#commit_pack");
  if(!state.commits.length){
    box.textContent = "(no staged commits yet)";
    return;
  }
  box.textContent = state.commits.join("\n");
}

function renderTrips(){
  const host = $("#trip_list");
  host.innerHTML = "";
  if(!state.trips.length){
    host.innerHTML = `<div class="miniHelp">No trips loaded from sheet yet. Check your Trips CSV link.</div>`;
    return;
  }

  for(const tr of state.trips){
    const included = !!state.tripIncluded[tr.name];
    const override = state.tripOverrides[tr.name];
    const shownCost = (override!==undefined && override!==null && override!=="") ? Number(override) : tr.total;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div class="rowTitle">${escapeHtml(tr.name)}</div>
        <div class="rowMeta">sheet cost: ${money(tr.total)} ${override?`• override: ${money(override)}`:""}</div>
      </div>
      <div class="rowRight">
        <span class="tag">${money(shownCost)}</span>
        <input data-trip="${escapeAttr(tr.name)}" class="tripOverride" type="number" step="1" style="width:140px" placeholder="Override cost" value="${override??""}">
        <button class="btn ${included ? "good" : ""}" data-inc="${escapeAttr(tr.name)}">${included ? "Included" : "Excluded"}</button>
        <button class="btn primary" data-commit-trip="${escapeAttr(tr.name)}">Stage as Expense</button>
      </div>
    `;
    host.appendChild(row);
  }

  // handlers
  host.querySelectorAll("button[data-inc]").forEach(b=>{
    b.onclick = () => {
      const name = b.getAttribute("data-inc");
      state.tripIncluded[name] = !state.tripIncluded[name];
      saveState(); renderAll();
    };
  });
  host.querySelectorAll("input.tripOverride").forEach(inp=>{
    inp.onchange = () => {
      const name = inp.getAttribute("data-trip");
      const v = inp.value;
      if(v === "") delete state.tripOverrides[name];
      else state.tripOverrides[name] = Number(v);
      saveState(); renderAll();
    };
  });
  host.querySelectorAll("button[data-commit-trip]").forEach(b=>{
    b.onclick = () => {
      const name = b.getAttribute("data-commit-trip");
      const tr = state.trips.find(t=>t.name===name);
      if(!tr) return;
      const v = state.tripOverrides[name];
      const amt = (v!==undefined && v!==null && v!=="") ? Number(v) : tr.total;
      stageCommitRow({
        date: isoDate(new Date(state.year, 11, 31)),
        amount: -Math.abs(amt),
        memo: `Trip: ${name}`
      });
      // also reflect as scenario cost immediately
      state.scenario.items.push({ id: uid(), type:"cost", amt: Math.abs(amt), note:`Trip staged: ${name}` });
      saveState(); renderAll();
    };
  });
}

function renderIncome(){
  // bind paycheck engine fields
  $("#pay_amount").value = state.paycheck.amount;
  $("#pay_start").value = state.paycheck.startDate;

  // render pay grid
  const grid = $("#pay_grid");
  grid.innerHTML = "";
  if(!state.paycheck.blocks.length){
    grid.innerHTML = `<div class="miniHelp">No paychecks generated yet. Click “Generate Paychecks”.</div>`;
  } else {
    // simple grid
    const wrap = document.createElement("div");
    wrap.style.display = "grid";
    wrap.style.gridTemplateColumns = "repeat(auto-fit, minmax(140px, 1fr))";
    wrap.style.gap = "10px";

    for(const b of state.paycheck.blocks){
      const btn = document.createElement("button");
      btn.className = "pill" + (b.received ? " active" : "");
      btn.style.borderRadius = "14px";
      btn.style.padding = "12px 10px";
      btn.innerHTML = `<div style="font-weight:800">${prettyDate(b.dateISO)}</div>
                       <div style="color:var(--muted2);font-size:12px;margin-top:4px">${money(b.amount)}</div>
                       <div style="color:${b.received ? "var(--good)" : "var(--muted2)"};font-size:12px;margin-top:6px">${b.received ? "Received" : "Pending"}</div>`;
      btn.onclick = ()=>{
        b.received = !b.received;
        saveState(); renderAll();
      };
      wrap.appendChild(btn);
    }
    grid.appendChild(wrap);
  }

  // extra income list
  const extraHost = $("#extra_income");
  extraHost.innerHTML = "";
  if(!state.extraIncome.length){
    extraHost.innerHTML = `<div class="miniHelp">No extra income yet.</div>`;
  } else {
    for(const x of state.extraIncome){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div>
          <div class="rowTitle">${escapeHtml(x.desc)}</div>
          <div class="rowMeta">${prettyDate(x.dateISO)} • ${money(x.amt)}</div>
        </div>
        <div class="rowRight">
          <button class="btn ${x.received ? "good" : ""}" data-xid="${x.id}">
            ${x.received ? "Received" : "Pending"}
          </button>
          <button class="btn bad" data-xdel="${x.id}">Delete</button>
          <button class="btn primary" data-xcommit="${x.id}">Stage to Sheet</button>
        </div>
      `;
      extraHost.appendChild(row);
    }
    extraHost.querySelectorAll("button[data-xid]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-xid");
        const it = state.extraIncome.find(z=>z.id===id);
        if(!it) return;
        it.received = !it.received;
        saveState(); renderAll();
      };
    });
    extraHost.querySelectorAll("button[data-xdel]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-xdel");
        state.extraIncome = state.extraIncome.filter(z=>z.id!==id);
        saveState(); renderAll();
      };
    });
    extraHost.querySelectorAll("button[data-xcommit]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-xcommit");
        const it = state.extraIncome.find(z=>z.id===id);
        if(!it) return;
        stageCommitRow({
          date: it.dateISO,
          amount: Math.abs(Number(it.amt||0)),
          memo: `Income: ${it.desc}`
        });
        saveState(); renderAll();
      };
    });
  }
}

function renderExpenses(){
  const host = $("#cat_list");
  host.innerHTML = "";
  if(!state.categories.length){
    host.innerHTML = `<div class="miniHelp">No categories yet. Add one below. (We’ll map these to your sheet later.)</div>`;
    return;
  }

  for(const c of state.categories){
    const remaining = Number(c.budget||0) - Number(c.spent||0);
    const pct = c.budget>0 ? Math.max(0, Math.min(100, (c.spent/c.budget)*100)) : 0;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div style="min-width:0">
        <div class="rowTitle">${escapeHtml(c.name)}</div>
        <div class="rowMeta">Budget ${money(c.budget)} • Spent ${money(c.spent)} • Remaining <span class="${remaining>=0?'good':'bad'}">${money(remaining)}</span></div>
        <div class="barWrap" style="margin-top:8px"><div class="bar" style="width:${pct}%;background:${remaining>=0?'var(--good)':'var(--bad)'}"></div></div>
      </div>
      <div class="rowRight">
        <input data-cat="${escapeAttr(c.id)}" class="logAmt" type="number" step="1" style="width:140px" placeholder="Log spend">
        <button class="btn bad" data-log="${escapeAttr(c.id)}">Log</button>
        <button class="btn primary" data-commit="${escapeAttr(c.id)}">Stage</button>
        <button class="btn bad" data-del="${escapeAttr(c.id)}">Delete</button>
      </div>
    `;
    host.appendChild(row);
  }

  host.querySelectorAll("button[data-log]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-log");
      const inp = host.querySelector(`input.logAmt[data-cat="${cssEscape(id)}"]`);
      const amt = Number(inp?.value||0);
      if(!amt) return;
      const c = state.categories.find(x=>x.id===id);
      if(!c) return;
      c.spent += Math.abs(amt);
      // scenario effect instantly (already in spent total)
      inp.value = "";
      saveState(); renderAll();
    };
  });

  host.querySelectorAll("button[data-commit]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-commit");
      const c = state.categories.find(x=>x.id===id);
      if(!c) return;
      // stage the cumulative spent as a single row (simple)
      stageCommitRow({
        date: isoDate(new Date()),
        amount: -Math.abs(Number(c.spent||0)),
        memo: `Spent: ${c.name}`
      });
      saveState(); renderAll();
    };
  });

  host.querySelectorAll("button[data-del]").forEach(b=>{
    b.onclick = ()=>{
      const id = b.getAttribute("data-del");
      state.categories = state.categories.filter(x=>x.id!==id);
      saveState(); renderAll();
    };
  });
}

/* =========================
   Actions
   ========================= */
function stageCommitRow({date, amount, memo}){
  // generic transaction row format: date,amount,memo
  // You can paste into a staging area or transform to your Transactions tab as needed.
  const line = `${date},${Number(amount).toFixed(2)},"${(memo||"").replaceAll('"','""')}"`;
  state.commits.push(line);
}

function prettyDate(iso){
  const d = new Date(iso);
  if(isNaN(d)) return iso;
  return d.toLocaleDateString(undefined,{month:"short",day:"numeric"});
}

/* =========================
   Pay engine
   ========================= */
function generatePaychecks(){
  const y = state.year;
  const amount = Number($("#pay_amount").value||0);
  const startISO = $("#pay_start").value;
  if(!amount || !startISO) return;

  state.paycheck.amount = amount;
  state.paycheck.startDate = startISO;

  const start = new Date(startISO + "T00:00:00");
  const blocks = [];
  // generate all dates within the selected year, biweekly
  let d = new Date(start);
  // move forward until in-year
  while(d.getFullYear() < y) d.setDate(d.getDate()+14);
  // if start after year, back up
  while(d.getFullYear() > y) d.setDate(d.getDate()-14);

  // ensure we start inside year
  while(d.getFullYear() === y){
    blocks.push({ id: uid(), dateISO: isoDate(d), amount, received: false });
    d.setDate(d.getDate()+14);
  }
  state.paycheck.blocks = blocks;
  saveState();
}

/* =========================
   Scenario controls
   ========================= */
function addScenario(type){
  const amt = Number($("#sim_amount").value||0);
  if(!amt) return;
  const note = $("#sim_note").value || "";
  state.scenario.items.push({ id: uid(), type, amt: Math.abs(amt), note });
  // stage commit row template (optional)
  if(type==="cost"){
    stageCommitRow({ date: isoDate(new Date()), amount: -Math.abs(amt), memo: note ? `Scenario cost: ${note}` : "Scenario cost" });
  } else {
    stageCommitRow({ date: isoDate(new Date()), amount: Math.abs(amt), memo: note ? `Scenario income: ${note}` : "Scenario income" });
  }
  $("#sim_amount").value = "";
  $("#sim_note").value = "";
  saveState();
  renderAll();
}

/* =========================
   Rendering master
   ========================= */
function renderAll(){
  renderYears();
  renderGoal();
  renderDashboard();
  renderIncome();
  renderExpenses();
  renderTrips();
}

/* =========================
   Init
   ========================= */
function wireUI(){
  // nav
  $$(".navBtn").forEach(b=>{
    b.onclick = ()=> setView(b.dataset.view);
  });

  // goal input
  $("#goalInput").addEventListener("change", ()=>{
    state.goalsByYear[state.year] = Number($("#goalInput").value||0);
    saveState(); renderAll();
  });

  // refresh
  $("#refreshBtn").onclick = async ()=>{
    $("#refreshBtn").textContent = "Refreshing…";
    try{
      await loadSheetData();
      renderAll();
    }catch(e){
      alert("Sheet refresh failed. Check CSV publish links.\n\n" + e.message);
    } finally {
      $("#refreshBtn").textContent = "Refresh Sheet";
    }
  };

  // scenario buttons
  $("#sim_add_cost").onclick = ()=> addScenario("cost");
  $("#sim_add_income").onclick = ()=> addScenario("income");
  $("#sim_clear").onclick = ()=>{
    state.scenario.items = [];
    state.commits = [];
    saveState(); renderAll();
  };

  // pay engine
  $("#pay_generate").onclick = ()=> { generatePaychecks(); renderAll(); };
  $("#pay_clear").onclick = ()=> { state.paycheck.blocks = []; saveState(); renderAll(); };

  // extra income
  $("#extra_add").onclick = ()=>{
    const desc = $("#extra_desc").value.trim();
    const amt = Number($("#extra_amt").value||0);
    const dateISO = $("#extra_date").value || isoDate(new Date(state.year,0,1));
    if(!desc || !amt) return;
    state.extraIncome.push({ id: uid(), desc, amt: Math.abs(amt), dateISO, received:false });
    $("#extra_desc").value = ""; $("#extra_amt").value=""; $("#extra_date").value="";
    saveState(); renderAll();
  };

  // categories
  $("#cat_add").onclick = ()=>{
    const name = $("#cat_name").value.trim();
    const budget = Number($("#cat_budget").value||0);
    if(!name || !budget) return;
    state.categories.push({ id: uid(), name, budget: Math.abs(budget), spent: 0 });
    $("#cat_name").value=""; $("#cat_budget").value="";
    saveState(); renderAll();
  };
}

// small escaping helpers
function escapeHtml(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function escapeAttr(s){ return String(s||"").replaceAll('"',"&quot;"); }
function cssEscape(s){ return String(s||"").replaceAll('"','\\"'); }

// Boot
(async function init(){
  wireUI();
  setView("dashboard");

  // load sheet once on first run if empty
  try{
    await loadSheetData();
  }catch(e){
    // don’t block the UI; user can refresh
    console.warn(e);
  }

  // default goal
  if(!state.goalsByYear[state.year]){
    state.goalsByYear[state.year] = state.goalsSheet[state.year] || 9500;
  }

  saveState();
  renderAll();
})();
</script>
</body>
</html>
